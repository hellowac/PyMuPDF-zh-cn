<!doctype html>
<html class="no-js" lang="zh-CN">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<meta content="Artifex" name="author" />
<meta content="PyMuPDF 是一个高性能 Python 库，用于 PDF（及其他）文档的数据提取、分析、转换和操作。" name="description" />
<meta content="PDF Text Extraction, PDF Image Extraction, PDF Conversion, PDF Tables, PDF Splitting, PDF Creation, Pyodide, PyScript" name="keywords" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JZTN4VTL9M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-JZTN4VTL9M');
    </script>
    <link rel="author" title="关于此文档" href="about.html" /><link rel="index" title="索引" href="genindex.html" /><link rel="search" title="搜索" href="search.html" /><link rel="next" title="日记" href="recipes-journalling.html" /><link rel="prev" title="绘图和图形" href="recipes-drawing-and-graphics.html" />

    <link rel="shortcut icon" href="_static/PyMuPDF.ico"/><!-- Generated with Sphinx 5.3.0 and Furo 2023.03.27 -->
        <title>故事 - PyMuPDF 1.25.4 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">PyMuPDF 1.25.4 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="_static/sidebar-logo-dark.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="_static/sidebar-logo-light.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">PyMuPDF 1.25.4 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">关于/About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="about.html">功能比较</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html#about-performance">性能</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html#about-license">许可和版权</a></li>
<li class="toctree-l1"><a class="reference internal" href="pymupdf4llm/index.html">PyMuPDF4LLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="pymupdf-pro.html">PyMuPDF Pro</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">用户指南/User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="the-basics.html">基础用法</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="rag.html">PyMuPDF、LLM 和 RAG</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">资源</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">教程/How to Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="how-to-open-a-file.html">打开文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes-text.html">文本</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes-images.html">图片</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes-annotations.html">注释</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes-drawing-and-graphics.html">绘图和图形</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">故事</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes-journalling.html">日记</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes-multiprocessing.html">多进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes-ocr.html">OCR - 光学字符识别</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes-optional-content.html">可选内容支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes-low-level-interfaces.html">低级接口</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes-common-issues-and-their-solutions.html">常见问题及其解决方案</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API参考/API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="module.html">命令行界面</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="classes.html">类</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="annot.html">Annot</a></li>
<li class="toctree-l2"><a class="reference internal" href="archive-class.html">Archive</a></li>
<li class="toctree-l2"><a class="reference internal" href="colorspace.html">Colorspace</a></li>
<li class="toctree-l2"><a class="reference internal" href="displaylist.html">DisplayList</a></li>
<li class="toctree-l2"><a class="reference internal" href="document.html">Document</a></li>
<li class="toctree-l2"><a class="reference internal" href="document-writer-class.html">DocumentWriter</a></li>
<li class="toctree-l2"><a class="reference internal" href="font.html">Font</a></li>
<li class="toctree-l2"><a class="reference internal" href="identity.html">Identity</a></li>
<li class="toctree-l2"><a class="reference internal" href="irect.html">IRect</a></li>
<li class="toctree-l2"><a class="reference internal" href="link.html">Link</a></li>
<li class="toctree-l2"><a class="reference internal" href="linkdest.html">linkDest</a></li>
<li class="toctree-l2"><a class="reference internal" href="matrix.html">Matrix</a></li>
<li class="toctree-l2"><a class="reference internal" href="outline.html">Outline</a></li>
<li class="toctree-l2"><a class="reference internal" href="page.html">Page</a></li>
<li class="toctree-l2"><a class="reference internal" href="pixmap.html">Pixmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="point.html">Point</a></li>
<li class="toctree-l2"><a class="reference internal" href="quad.html">Quad</a></li>
<li class="toctree-l2"><a class="reference internal" href="rect.html">Rect</a></li>
<li class="toctree-l2"><a class="reference internal" href="shape.html">Shape</a></li>
<li class="toctree-l2"><a class="reference internal" href="story-class.html">Story</a></li>
<li class="toctree-l2"><a class="reference internal" href="textpage.html">TextPage</a></li>
<li class="toctree-l2"><a class="reference internal" href="textwriter.html">TextWriter</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools.html">Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="widget.html">Widget</a></li>
<li class="toctree-l2"><a class="reference internal" href="xml-class.html">Xml</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="algebra.html">几何对象的运算符代数</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="lowlevel.html">低级函数和类</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="functions.html">函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="device.html">设备</a></li>
<li class="toctree-l2"><a class="reference internal" href="coop_low.html">协同工作: DisplayList 和 TextPage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="vars.html">常量和枚举</a></li>
<li class="toctree-l1"><a class="reference internal" href="colors.html">颜色数据库</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">其他/Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="app1.html">附录 1：文本提取详细信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="app2.html">附录 2：嵌入式文件的注意事项</a></li>
<li class="toctree-l1"><a class="reference internal" href="app3.html">附录 3：各类技术信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="app4.html">附录 4：性能比较方法</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">更新日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="znames.html">已废弃名称</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div style="display:flex;justify-content:space-between;align-items: center;">
    <form class="sidebar-search-container top" method="get" action="search.html" role="search" style="width:75%">
      <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
      <input type="hidden" name="check_keywords" value="yes">
      <input type="hidden" name="area" value="default">
    </form>
</div>

<div style="display:flex;justify-content:space-between;align-items:center;margin-top:20px;">
    <div class="discordLink" style="display:flex;align-items:center;margin-top: -5px;">
        <a href="https://discord.gg/TSpYGBW4eq" id="findOnDiscord" target=_blank>Find <b>#pymupdf</b> on <b>Discord</b></a>
        <a href="https://discord.gg/TSpYGBW4eq" target=_blank>
            <div style="width:30px;height:30px;margin-left:5px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 127.14 96.36">
                    <defs>
                        <style>.discordLogoFill{fill:#5865f2;}</style>
                    </defs>
                    <g id="Discord_Logo" data-name="Discord Logo">
                        <path class="discordLogoFill" d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
                    </g>
                </svg>
            </div>
        </a>
    </div>

</div><span class="target" id="recipesstories"></span><section id="id1">
<h1>故事<a class="headerlink" href="#id1" title="此标题的永久链接">#</a></h1>
<p>Stories</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<p>本文档展示了一些 <a class="reference internal" href="tutorial.html#workingwithstories"><span class="std std-ref">故事（Stories）</span></a> 的典型用例。</p>
<p>正如 <a class="reference internal" href="tutorial.html#workingwithstories"><span class="std std-ref">教程</span></a> 所述，故事可以使用最多三种输入来源创建：HTML、CSS 和存档（Archives）。这些输入都是可选的，并且可以通过编程方式提供。</p>
<p>以下示例将展示这些输入的不同组合方式。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>许多示例的源代码已包含在 <code class="xref any docutils literal notranslate"><span class="pre">docs</span></code> 文件夹中。</p>
</div>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<p>This document showcases some typical use cases for <a class="reference internal" href="tutorial.html#workingwithstories"><span class="std std-ref">Stories</span></a>.</p>
<p>As mentioned in the <a class="reference internal" href="tutorial.html#workingwithstories"><span class="std std-ref">tutorial</span></a>, stories may be created using up to three input sources: HTML, CSS and Archives – all of which are optional and which, respectively, can be provided programmatically.</p>
<p>The following examples will showcase combinations for using these inputs.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Many of these recipe’s source code are included as examples in the <code class="xref any docutils literal notranslate"><span class="pre">docs</span></code> folder.</p>
</div>
</div>
</div>
<section id="recipesstories-a">
<span id="id2"></span><h2>如何添加一行带格式的文本<a class="headerlink" href="#recipesstories-a" title="此标题的永久链接">#</a></h2>
<p>How to Add a Line of Text with Some Formatting</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p>这里是不可避免的 “Hello World” 示例。我们将展示两种变体：</p>
<ol class="arabic simple">
<li><p>使用现有的 HTML 源 <a class="footnote-reference brackets" href="#f2" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>，它可以来自任何地方。</p></li>
<li><p>使用 Python API 进行创建。</p></li>
</ol>
<p><strong>使用现有 HTML 源的变体</strong> <a class="footnote-reference brackets" href="#f2" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> —— 在本例中，该 HTML 源被定义为脚本中的一个常量:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">HTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;p style=&quot;font-family: sans-serif;color: blue&quot;&gt;Hello World!&lt;/p&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>  <span class="c1"># 输出页面格式：Letter</span>
<span class="n">WHERE</span> <span class="o">=</span> <span class="n">MEDIABOX</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>  <span class="c1"># 保留 0.5 英寸的边距</span>

<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">HTML</span><span class="p">)</span>  <span class="c1"># 从 HTML 创建故事</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="s2">&quot;output.pdf&quot;</span><span class="p">)</span>  <span class="c1"># 创建写入器</span>

<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 当 more 设为 0 时，表示输入结束</span>

<span class="k">while</span> <span class="n">more</span><span class="p">:</span>  <span class="c1"># 循环输出故事</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>  <span class="c1"># 创建新页面</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>  <span class="c1"># 在允许的矩形区域内布局</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># 在页面上绘制内容</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>  <span class="c1"># 结束页面</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭输出文件</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>上述效果（无衬线字体和蓝色文本）也可以通过单独的 CSS 资源实现，如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">body {</span>
<span class="s2">    font-family: sans-serif;</span>
<span class="s2">    color: blue;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">HTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;p&gt;Hello World!&lt;/p&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># 这样创建故事：</span>
<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">HTML</span><span class="p">,</span> <span class="n">user_css</span><span class="o">=</span><span class="n">CSS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><strong>Python API 变体</strong> —— 所有内容均通过编程方式创建:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>
<span class="n">WHERE</span> <span class="o">=</span> <span class="n">MEDIABOX</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>

<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>  <span class="c1"># 创建一个空的故事</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># 访问其 DOM 的 body</span>
<span class="k">with</span> <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span> <span class="k">as</span> <span class="n">para</span><span class="p">:</span>  <span class="c1"># 存储所需内容</span>
    <span class="n">para</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s2">&quot;Hello World!&quot;</span><span class="p">)</span>

<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="s2">&quot;output.pdf&quot;</span><span class="p">)</span>

<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">while</span> <span class="n">more</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>两种变体都会生成相同的输出 PDF。</p>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p>Here is the inevitable “Hello World” example. We will show two variants:</p>
<ol class="arabic simple">
<li><p>Create using existing HTML source <a class="footnote-reference brackets" href="#f1" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, that may come from anywhere.</p></li>
<li><p>Create using the Python API.</p></li>
</ol>
<p>Variant using an existing HTML source <a class="footnote-reference brackets" href="#f1" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> – which in this case is defined as a constant in the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">HTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;p style=&quot;font-family: sans-serif;color: blue&quot;&gt;Hello World!&lt;/p&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>  <span class="c1"># output page format: Letter</span>
<span class="n">WHERE</span> <span class="o">=</span> <span class="n">MEDIABOX</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>  <span class="c1"># leave borders of 0.5 inches</span>

<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">HTML</span><span class="p">)</span>  <span class="c1"># create story from HTML</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="s2">&quot;output.pdf&quot;</span><span class="p">)</span>  <span class="c1"># create the writer</span>

<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># will indicate end of input once it is set to 0</span>

<span class="k">while</span> <span class="n">more</span><span class="p">:</span>  <span class="c1"># loop outputting the story</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>  <span class="c1"># make new page</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>  <span class="c1"># layout into allowed rectangle</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># write on page</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>  <span class="c1"># finish page</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close output file</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The above effect (sans-serif and blue text) could have been achieved by using a separate CSS source like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">body {</span>
<span class="s2">    font-family: sans-serif;</span>
<span class="s2">    color: blue;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">HTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;p&gt;Hello World!&lt;/p&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># the story would then be created like this:</span>
<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">HTML</span><span class="p">,</span> <span class="n">user_css</span><span class="o">=</span><span class="n">CSS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The Python API variant – everything is created programmatically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>
<span class="n">WHERE</span> <span class="o">=</span> <span class="n">MEDIABOX</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>

<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>  <span class="c1"># create an empty story</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># access the body of its DOM</span>
<span class="k">with</span> <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span> <span class="k">as</span> <span class="n">para</span><span class="p">:</span>  <span class="c1"># store desired content</span>
    <span class="n">para</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s2">&quot;Hello World!&quot;</span><span class="p">)</span>

<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="s2">&quot;output.pdf&quot;</span><span class="p">)</span>

<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">while</span> <span class="n">more</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Both variants will produce the same output PDF.</p>
</div>
</div>
<hr class="docutils" />
</section>
<section id="recipesstories-b">
<span id="id7"></span><h2>如何使用图像<a class="headerlink" href="#recipesstories-b" title="此标题的永久链接">#</a></h2>
<p>How to use Images</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<p>图片可以在提供的 HTML 源代码中引用，也可以通过 Python API 存储对所需图片的引用。无论哪种方式，都需要使用 <a class="reference internal" href="archive-class.html#archive"><span class="std std-ref">Archive</span></a>，它指向图片所在的位置。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>嵌入 HTML 源代码中的二进制内容的图片 <strong>不支持</strong> 在 stories 中使用。</p>
</div>
<p>我们扩展了上面的 “Hello World” 示例，并在文本后面显示我们的星球图片。假设图片的名称为 “world.jpg” 且位于脚本文件夹中，那么下面是修改后的 Python API 变体:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>
<span class="n">WHERE</span> <span class="o">=</span> <span class="n">MEDIABOX</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>

<span class="c1"># 创建故事，让它查看脚本文件夹中的资源</span>
<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># 访问其 DOM 的 body</span>

<span class="k">with</span> <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span> <span class="k">as</span> <span class="n">para</span><span class="p">:</span>
    <span class="c1"># 存储所需内容</span>
    <span class="n">para</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s2">&quot;Hello World!&quot;</span><span class="p">)</span>

<span class="c1"># 另一个段落用于我们的图片：</span>
<span class="k">with</span> <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span> <span class="k">as</span> <span class="n">para</span><span class="p">:</span>
    <span class="c1"># 在另一个段落中存储图片</span>
    <span class="n">para</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="s2">&quot;world.jpg&quot;</span><span class="p">)</span>

<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="s2">&quot;output.pdf&quot;</span><span class="p">)</span>

<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">while</span> <span class="n">more</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<p>Images can be referenced in the provided HTML source, or the reference to a desired image can also be stored via the Python API. In any case, this requires using an <a class="reference internal" href="archive-class.html#archive"><span class="std std-ref">Archive</span></a>, which refers to the place where the image can be found.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Images with the binary content embedded in the HTML source are <strong>not supported</strong> by stories.</p>
</div>
<p>We extend our “Hello World” example from above and display an image of our planet right after the text. Assuming the image has the name “world.jpg” and is present in the script’s folder, then this is the modified version of the above Python API variant:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>
<span class="n">WHERE</span> <span class="o">=</span> <span class="n">MEDIABOX</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>

<span class="c1"># create story, let it look at script folder for resources</span>
<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># access the body of its DOM</span>

<span class="k">with</span> <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span> <span class="k">as</span> <span class="n">para</span><span class="p">:</span>
    <span class="c1"># store desired content</span>
    <span class="n">para</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s2">&quot;Hello World!&quot;</span><span class="p">)</span>

<span class="c1"># another paragraph for our image:</span>
<span class="k">with</span> <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span> <span class="k">as</span> <span class="n">para</span><span class="p">:</span>
    <span class="c1"># store image in another paragraph</span>
    <span class="n">para</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="s2">&quot;world.jpg&quot;</span><span class="p">)</span>

<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="s2">&quot;output.pdf&quot;</span><span class="p">)</span>

<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">while</span> <span class="n">more</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
</section>
<section id="html-css">
<span id="recipesstories-c"></span><h2>如何读取故事的外部 HTML 和 CSS<a class="headerlink" href="#html-css" title="此标题的永久链接">#</a></h2>
<p>How to Read External HTML and CSS for a Story</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<p>这些情况相对简单。</p>
<p>作为一般建议，HTML 和 CSS 源文件应该 <strong>以二进制文件形式读取</strong>，并在使用它们创建故事之前进行解码。Python 的 <code class="xref any docutils literal notranslate"><span class="pre">pathlib.Path</span></code> 提供了方便的方式来实现这一点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">htmlpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;myhtml.html&quot;</span><span class="p">)</span>
<span class="n">csspath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;mycss.css&quot;</span><span class="p">)</span>

<span class="n">HTML</span> <span class="o">=</span> <span class="n">htmlpath</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="n">CSS</span> <span class="o">=</span> <span class="n">csspath</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">HTML</span><span class="p">,</span> <span class="n">user_css</span><span class="o">=</span><span class="n">CSS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<p>These cases are fairly straightforward.</p>
<p>As a general recommendation, HTML and CSS sources should be <strong>read as binary files</strong> and decoded before using them in a story. The Python <code class="xref any docutils literal notranslate"><span class="pre">pathlib.Path</span></code> provides convenient ways to do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">htmlpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;myhtml.html&quot;</span><span class="p">)</span>
<span class="n">csspath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;mycss.css&quot;</span><span class="p">)</span>

<span class="n">HTML</span> <span class="o">=</span> <span class="n">htmlpath</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="n">CSS</span> <span class="o">=</span> <span class="n">csspath</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">HTML</span><span class="p">,</span> <span class="n">user_css</span><span class="o">=</span><span class="n">CSS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
</section>
<section id="recipesstories-d">
<span id="id8"></span><h2>如何使用故事模板输出数据库内容<a class="headerlink" href="#recipesstories-d" title="此标题的永久链接">#</a></h2>
<p>How to Output Database Content with Story Templates</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<p>这个脚本演示了如何使用 <strong>HTML 模板</strong> 报告 SQL 数据库内容。</p>
<p>示例 SQL 数据库包含两个表：</p>
<ol class="arabic simple">
<li><p>表 “films” 包含每部电影的一行数据，字段包括 <strong>“title”</strong>、 <strong>“director”</strong>  和（上映年份） <strong>“year”</strong>。</p></li>
<li><p>表 “actors” 包含每位演员和电影标题的一行数据，字段包括（演员） <strong>“name”</strong> 和 （电影） <strong>“title”</strong> 。</p></li>
</ol>
<p>故事 DOM 由一个电影的模板组成，报告电影数据以及一个演员名单。</p>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/filmfestival-sql.py</span></code></p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/filmfestival-sql.db</span></code></p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<p>This script demonstrates how to report SQL database content using an <strong>HTML template</strong>.</p>
<p>The example SQL database contains two tables:</p>
<ol class="arabic simple">
<li><p>Table “films” contains one row per film with the fields <strong>“title”</strong>, <strong>“director”</strong> and (release) <strong>“year”</strong>.</p></li>
<li><p>Table “actors” contains one row per actor and film title (fields (actor) <strong>“name”</strong> and (film) <strong>“title”</strong>).</p></li>
</ol>
<p>The story DOM consists of a template for one film, which reports film data together with a list of casted actors.</p>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/filmfestival-sql.py</span></code></p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/filmfestival-sql.db</span></code></p></li>
</ul>
</div>
</div>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is a demo script for using PyMuPDF with its &quot;Story&quot; feature.</span>

<span class="sd">The following aspects are being covered here:</span>

<span class="sd">* The script produces a report of films that are stored in an SQL database</span>
<span class="sd">* The report format is provided as a HTML template</span>

<span class="sd">The SQL database contains two tables:</span>
<span class="sd">1. Table &quot;films&quot; which has the columns &quot;title&quot; (film title, str), &quot;director&quot;</span>
<span class="sd">   (str) and &quot;year&quot; (year of release, int).</span>
<span class="sd">2. Table &quot;actors&quot; which has the columns &quot;name&quot; (actor name, str) and &quot;title&quot;</span>
<span class="sd">   (the film title where the actor had been casted, str).</span>

<span class="sd">The script reads all content of the &quot;films&quot; table. For each film title it</span>
<span class="sd">reads all rows from table &quot;actors&quot; which took part in that film.</span>

<span class="sd">Comment 1</span>
<span class="sd">---------</span>
<span class="sd">To keep things easy and free from pesky technical detail, the relevant file</span>
<span class="sd">names inherit the name of this script:</span>
<span class="sd">- the database&#39;s filename is the script name with &quot;.py&quot; extension replaced</span>
<span class="sd">  by &quot;.db&quot;.</span>
<span class="sd">- the output PDF similarly has script file name with extension &quot;.pdf&quot;.</span>

<span class="sd">Comment 2</span>
<span class="sd">---------</span>
<span class="sd">The SQLITE database has been created using https://sqlitebrowser.org/, a free</span>
<span class="sd">multi-platform tool to maintain or manipulate SQLITE databases.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="c1"># ----------------------------------------------------------------------</span>
<span class="c1"># HTML template for the film report</span>
<span class="c1"># There are four placeholders coded as &quot;id&quot; attributes.</span>
<span class="c1"># One &quot;id&quot; allows locating the template part itself, the other three</span>
<span class="c1"># indicate where database text should be inserted.</span>
<span class="c1"># ----------------------------------------------------------------------</span>
<span class="n">festival_template</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Just some arbitrary text&lt;/title&gt;&lt;/head&gt;&quot;</span>
    <span class="s1">&#39;&lt;body&gt;&lt;h1 style=&quot;text-align:center&quot;&gt;Hook Norton Film Festival&lt;/h1&gt;&#39;</span>
    <span class="s2">&quot;&lt;ol&gt;&quot;</span>
    <span class="s1">&#39;&lt;li id=&quot;filmtemplate&quot;&gt;&#39;</span>
    <span class="s1">&#39;&lt;b id=&quot;filmtitle&quot;&gt;&lt;/b&gt;&#39;</span>
    <span class="s2">&quot;&lt;dl&gt;&quot;</span>
    <span class="s1">&#39;&lt;dt&gt;Director&lt;dd id=&quot;director&quot;&gt;&#39;</span>
    <span class="s1">&#39;&lt;dt&gt;Release Year&lt;dd id=&quot;filmyear&quot;&gt;&#39;</span>
    <span class="s1">&#39;&lt;dt&gt;Cast&lt;dd id=&quot;cast&quot;&gt;&#39;</span>
    <span class="s2">&quot;&lt;/dl&gt;&quot;</span>
    <span class="s2">&quot;&lt;/li&gt;&quot;</span>
    <span class="s2">&quot;&lt;/ol&gt;&quot;</span>
    <span class="s2">&quot;&lt;/body&gt;&lt;/html&quot;</span>
<span class="p">)</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># define database access</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">dbfilename</span> <span class="o">=</span> <span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.db&quot;</span><span class="p">)</span>  <span class="c1"># the SQLITE database file name</span>
<span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dbfilename</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dbfilename</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">database</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbfilename</span><span class="p">)</span>  <span class="c1"># open database</span>
<span class="n">cursor_films</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>  <span class="c1"># cursor for selecting the films</span>
<span class="n">cursor_casts</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>  <span class="c1"># cursor for selecting actors per film</span>

<span class="c1"># select statement for the films - let SQL also sort it for us</span>
<span class="n">select_films</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT title, director, year FROM films ORDER BY title&quot;&quot;&quot;</span>

<span class="c1"># select stament for actors, a skeleton: sub-select by film title</span>
<span class="n">select_casts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT name FROM actors WHERE film = &quot;</span><span class="si">%s</span><span class="s2">&quot; ORDER BY name&quot;&quot;&quot;</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># define the HTML Story and fill it with database data</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">festival_template</span><span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># access the HTML body detail</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;filmtemplate&quot;</span><span class="p">)</span>  <span class="c1"># find the template part</span>

<span class="c1"># read the films from the database and put them all in one Python list</span>
<span class="c1"># NOTE: instead we might fetch rows one by one (advisable for large volumes)</span>
<span class="n">cursor_films</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select_films</span><span class="p">)</span>  <span class="c1"># execute cursor, and ...</span>
<span class="n">films</span> <span class="o">=</span> <span class="n">cursor_films</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>  <span class="c1"># read out what was found</span>

<span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">director</span><span class="p">,</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">films</span><span class="p">:</span>  <span class="c1"># iterate through the films</span>
    <span class="n">film</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>  <span class="c1"># clone template to report each film</span>
    <span class="n">film</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;filmtitle&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>  <span class="c1"># put title in templ</span>
    <span class="n">film</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;director&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">director</span><span class="p">)</span>  <span class="c1"># put director</span>
    <span class="n">film</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;filmyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>  <span class="c1"># put year</span>

    <span class="c1"># the actors reside in their own table - find the ones for this film title</span>
    <span class="n">cursor_casts</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select_casts</span> <span class="o">%</span> <span class="n">title</span><span class="p">)</span>  <span class="c1"># execute cursor</span>
    <span class="n">casts</span> <span class="o">=</span> <span class="n">cursor_casts</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>  <span class="c1"># read actors for the film</span>
    <span class="c1"># each actor name appears in its own tuple, so extract it from there</span>
    <span class="n">film</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">casts</span><span class="p">]))</span>
    <span class="n">body</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="n">film</span><span class="p">)</span>

<span class="n">template</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># remove the template</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># generate the PDF</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">),</span> <span class="s2">&quot;compress&quot;</span><span class="p">)</span>
<span class="n">mediabox</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;a4&quot;</span><span class="p">)</span>  <span class="c1"># use pages in ISO-A4 format</span>
<span class="n">where</span> <span class="o">=</span> <span class="n">mediabox</span> <span class="o">+</span> <span class="p">(</span><span class="mi">72</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">72</span><span class="p">)</span>  <span class="c1"># leave page borders</span>

<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># end of output indicator</span>

<span class="k">while</span> <span class="n">more</span><span class="p">:</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">mediabox</span><span class="p">)</span>  <span class="c1"># make a new page</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">filled</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>  <span class="c1"># arrange content for this page</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># write content to page</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>  <span class="c1"># finish the page</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close the PDF</span>
</pre></div>
</div>
<p></details></p>
<hr class="docutils" />
</section>
<section id="pdf">
<span id="recipesstories-e"></span><h2>如何与现有 PDF 集成<a class="headerlink" href="#pdf" title="此标题的永久链接">#</a></h2>
<p>How to Integrate with Existing PDFs</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">中文</label><div class="tab-content docutils container">
<p>由于 <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> 只能写入新文件，因此故事无法放置在现有页面上。这个脚本演示了如何规避这一限制。</p>
<p>基本思路是让 <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> 将输出写入内存中的 PDF。一旦故事完成，我们重新打开这个内存中的 PDF，并通过 <a class="reference internal" href="page.html#Page.show_pdf_page" title="Page.show_pdf_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.show_pdf_page()</span></code></a> 方法将其页面放置到 <strong>现有</strong> 页面上的所需位置。</p>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/showpdf-page.py</span></code></p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">英文</label><div class="tab-content docutils container">
<p>Because a <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> can only write to a new file, stories cannot be placed on existing pages. This script demonstrates a circumvention of this restriction.</p>
<p>The basic idea is letting <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> output to a PDF in memory. Once the story has finished, we re-open this memory PDF and put its pages to desired locations on <strong>existing</strong> pages via method <a class="reference internal" href="page.html#Page.show_pdf_page" title="Page.show_pdf_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.show_pdf_page()</span></code></a>.</p>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/showpdf-page.py</span></code></p></li>
</ul>
</div>
</div>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demo of Story class in PyMuPDF</span>
<span class="sd">-------------------------------</span>

<span class="sd">This script demonstrates how to the results of a pymupdf.Story output can be</span>
<span class="sd">placed in a rectangle of an existing (!) PDF page.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_pdf</span><span class="p">(</span><span class="n">fileptr</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a memory DocumentWriter from HTML text and a rect.</span>

<span class="sd">    Args:</span>
<span class="sd">        fileptr: a Python file object. For example an io.BytesIO().</span>
<span class="sd">        text: the text to output (HTML format)</span>
<span class="sd">        rect: the target rectangle. Will use its width / height as mediabox</span>
<span class="sd">        font: (str) font family name, default sans-serif</span>
<span class="sd">        archive: pymupdf.Archive parameter. To be used if e.g. images or special</span>
<span class="sd">                fonts should be used.</span>
<span class="sd">    Returns:</span>
<span class="sd">        The matrix to convert page rectangles of the created PDF back</span>
<span class="sd">        to rectangle coordinates in the parameter &quot;rect&quot;.</span>
<span class="sd">        Normal use will expect to fit all the text in the given rect.</span>
<span class="sd">        However, if an overflow occurs, this function will output multiple</span>
<span class="sd">        pages, and the caller may decide to either accept or retry with</span>
<span class="sd">        changed parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># use input rectangle as the page dimension</span>
    <span class="n">mediabox</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rect</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">rect</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
    <span class="c1"># this matrix converts mediabox back to input rect</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">mediabox</span><span class="o">.</span><span class="n">torect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

    <span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="n">archive</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>
    <span class="n">body</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="n">fileptr</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">mediabox</span><span class="p">)</span>
        <span class="n">more</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">mediabox</span><span class="p">)</span>
        <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">more</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">matrix</span>


<span class="c1"># -------------------------------------------------------------</span>
<span class="c1"># We want to put this in a given rectangle of an existing page</span>
<span class="c1"># -------------------------------------------------------------</span>
<span class="n">HTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;p&gt;PyMuPDF is a great package! And it still improves significantly from one version to the next one!&lt;/p&gt;</span>
<span class="s2">&lt;p&gt;It is a Python binding for &lt;b&gt;MuPDF&lt;/b&gt;, a lightweight PDF, XPS, and E-book viewer, renderer, and toolkit.&lt;br&gt; Both are maintained and developed by Artifex Software, Inc.&lt;/p&gt;</span>
<span class="s2">&lt;p&gt;Via MuPDF it can access files in PDF, XPS, OpenXPS, CBZ, EPUB, MOBI and FB2 (e-books) formats,&lt;br&gt; and it is known for its top</span>
<span class="s2">&lt;b&gt;&lt;i&gt;performance&lt;/i&gt;&lt;/b&gt; and &lt;b&gt;&lt;i&gt;rendering quality.&lt;/p&gt;&quot;&quot;&quot;</span>

<span class="c1"># Make a PDF page for demo purposes</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__file__</span><span class="si">}</span><span class="s2">/..&quot;</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">/mupdf-title.pdf&quot;</span><span class="p">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">WHERE</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>  <span class="c1"># target rectangle on existing page</span>

<span class="n">fileptr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>  <span class="c1"># let DocumentWriter use this as its file</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># call DocumentWriter and Story to fill our rectangle</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">make_pdf</span><span class="p">(</span><span class="n">fileptr</span><span class="p">,</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">WHERE</span><span class="p">)</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">src</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">fileptr</span><span class="p">)</span>  <span class="c1"># open DocumentWriter output PDF</span>
<span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">page_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># target rect was too small</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target WHERE too small&quot;</span><span class="p">)</span>

<span class="c1"># its page 0 contains our result</span>
<span class="n">page</span><span class="o">.</span><span class="n">show_pdf_page</span><span class="p">(</span><span class="n">WHERE</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">doc</span><span class="o">.</span><span class="n">ez_save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">/mupdf-title-after.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p></details></p>
<hr class="docutils" />
</section>
<section id="pymupdf-fonts">
<span id="recipesstories-f"></span><h2>如何从包 <a class="reference external" href="https://github.com/pymupdf/pymupdf-fonts">pymupdf-fonts</a> 制作多列布局和访问字体<a class="headerlink" href="#pymupdf-fonts" title="此标题的永久链接">#</a></h2>
<p>How to Make Multi-Columned Layouts and Access Fonts from Package <a class="reference external" href="https://github.com/pymupdf/pymupdf-fonts">pymupdf-fonts</a></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">中文</label><div class="tab-content docutils container">
<p>这个脚本输出了一篇文章（来自 Wikipedia），该文章包含文本和多张图片，并使用了 2 列页面布局。</p>
<p>此外，脚本使用了 <a class="reference external" href="https://github.com/pymupdf/pymupdf-fonts">pymupdf-fonts</a> 包中的两个 “Ubuntu” 字体系列，而不是默认的 Base-14 字体。</p>
<p>另一个特性是，所有数据——图片和文章 HTML——都共同存储在一个 ZIP 文件中。</p>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/quickfox.py</span></code></p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/quickfox.zip</span></code></p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--2">英文</label><div class="tab-content docutils container">
<p>This script outputs an article (taken from Wikipedia) that contains text and multiple images and uses a 2-column page layout.</p>
<p>In addition, two “Ubuntu” font families from package <a class="reference external" href="https://github.com/pymupdf/pymupdf-fonts">pymupdf-fonts</a> are used instead of defaulting to Base-14 fonts.</p>
<p>Yet another feature used here is that all data – the images and the article HTML – are jointly stored in a ZIP file.</p>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/quickfox.py</span></code></p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/quickfox.zip</span></code></p></li>
</ul>
</div>
</div>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is a demo script using PyMuPDF&#39;s Story class to output text as a PDF with</span>
<span class="sd">a two-column page layout.</span>

<span class="sd">The script demonstrates the following features:</span>
<span class="sd">* How to fill columns or table cells of complex page layouts</span>
<span class="sd">* How to embed images</span>
<span class="sd">* How to modify existing, given HTML sources for output (text indent, font size)</span>
<span class="sd">* How to use fonts defined in package &quot;pymupdf-fonts&quot;</span>
<span class="sd">* How to use ZIP files as Archive</span>

<span class="sd">--------------</span>
<span class="sd">The example is taken from the somewhat modified Wikipedia article</span>
<span class="sd">https://en.wikipedia.org/wiki/The_quick_brown_fox_jumps_over_the_lazy_dog.</span>
<span class="sd">--------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>


<span class="n">thisdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">myzip</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">thisdir</span><span class="p">,</span> <span class="s2">&quot;quickfox.zip&quot;</span><span class="p">))</span>
<span class="n">arch</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Archive</span><span class="p">(</span><span class="n">myzip</span><span class="p">)</span>

<span class="k">if</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">fitz_fontdescriptors</span><span class="p">:</span>
    <span class="c1"># we want to use the Ubuntu fonts for sans-serif and for monospace</span>
    <span class="n">CSS</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">css_for_pymupdf_font</span><span class="p">(</span><span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="n">arch</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>
    <span class="n">CSS</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">css_for_pymupdf_font</span><span class="p">(</span><span class="s2">&quot;ubuntm&quot;</span><span class="p">,</span> <span class="n">CSS</span><span class="o">=</span><span class="n">CSS</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="n">arch</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;monospace&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># No pymupdf-fonts available.</span>
    <span class="n">CSS</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="n">docname</span> <span class="o">=</span> <span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>  <span class="c1"># output PDF file name</span>

<span class="n">HTML</span> <span class="o">=</span> <span class="n">myzip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;quickfox.html&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="c1"># make the Story object</span>
<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">HTML</span><span class="p">,</span> <span class="n">user_css</span><span class="o">=</span><span class="n">CSS</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="n">arch</span><span class="p">)</span>

<span class="c1"># --------------------------------------------------------------</span>
<span class="c1"># modify the DOM somewhat</span>
<span class="c1"># --------------------------------------------------------------</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># access HTML body</span>
<span class="n">body</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>  <span class="c1"># and give it our font globally</span>

<span class="c1"># modify certain nodes</span>
<span class="n">para</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># find relevant nodes (here: paragraphs)</span>
<span class="k">while</span> <span class="n">para</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">para</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span>  <span class="c1"># method MUST be used for existing nodes</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">para</span> <span class="o">=</span> <span class="n">para</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># choose PDF page size</span>
<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>
<span class="c1"># text appears only within this subrectangle</span>
<span class="n">WHERE</span> <span class="o">=</span> <span class="n">MEDIABOX</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>

<span class="c1"># --------------------------------------------------------------</span>
<span class="c1"># define page layout within the WHERE rectangle</span>
<span class="c1"># --------------------------------------------------------------</span>
<span class="n">COLS</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># layout: 2 cols 1 row</span>
<span class="n">ROWS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">TABLE</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">make_table</span><span class="p">(</span><span class="n">WHERE</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">COLS</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">ROWS</span><span class="p">)</span>
<span class="c1"># fill the cells of each page in this sequence:</span>
<span class="n">CELLS</span> <span class="o">=</span> <span class="p">[</span><span class="n">TABLE</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ROWS</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">COLS</span><span class="p">)]</span>

<span class="n">fileobject</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>  <span class="c1"># let DocumentWriter write to memory</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="n">fileobject</span><span class="p">)</span>  <span class="c1"># define the writer</span>

<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">while</span> <span class="n">more</span><span class="p">:</span>  <span class="c1"># loop until all input text has been written out</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>  <span class="c1"># prepare a new output page</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">CELLS</span><span class="p">:</span>
        <span class="c1"># content may be complete after any cell, ...</span>
        <span class="k">if</span> <span class="n">more</span><span class="p">:</span>  <span class="c1"># so check this status first</span>
            <span class="n">more</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>  <span class="c1"># finish the PDF page</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close DocumentWriter output</span>

<span class="c1"># for housekeeping work re-open from memory</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">fileobject</span><span class="p">)</span>
<span class="n">doc</span><span class="o">.</span><span class="n">ez_save</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
</pre></div>
</div>
<p></details></p>
<hr class="docutils" />
</section>
<section id="recipesstories-g">
<span id="id9"></span><h2>如何制作环绕预定义“禁区”布局的布局<a class="headerlink" href="#recipesstories-g" title="此标题的永久链接">#</a></h2>
<p>How to Make a Layout which Wraps Around a Predefined “no go area” Layout</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">中文</label><div class="tab-content docutils container">
<p>这是一个使用 PyMuPDF 的 Story 类输出文本为 PDF 的演示脚本，具有双栏页面布局。</p>
<p>该脚本演示了以下特性：</p>
<ul class="simple">
<li><p>在现有的（”目标”）PDF 上布局文本和图片。</p></li>
<li><p>基于一些全局参数，识别每页上的区域，这些区域可以用于接收由 Story 布局的文本。</p></li>
<li><p>这些全局参数不会存储在目标 PDF 中，因此必须以某种方式提供：</p></li>
</ul>
<ul class="simple">
<li><p>每页的边距宽度。</p></li>
<li><p>用于文本的字体大小。这个值决定了提供的文本是否能够适应目标 PDF 固定页面上的空白区域。无法预测。如果目标 PDF 没有足够的页面，脚本会抛出异常，并在某些页面没有至少一些文本时打印警告消息。在这两种情况下，可以修改 FONTSIZE 值（浮动值）。</p></li>
<li><p>使用双栏页面布局来布局文本。</p></li>
</ul>
<ul class="simple">
<li><p>布局会创建一个临时的（内存中的）PDF。生成的页面内容（文本）会覆盖目标页面的相应位置。如果文本需要的页数超过目标 PDF 可用的页数，则会抛出异常。如果不是所有目标页面都接收到至少一些文本，将打印警告信息。</p></li>
<li><p>脚本读取当前文件夹中的 “image-no-go.pdf”。这是 “目标” PDF，它包含 2 页，每页上有 2 张图片（来自原始文章），这些图片被放置在创建广泛测试覆盖的地方。否则，页面是空的。</p></li>
<li><p>脚本生成 “quickfox-image-no-go.pdf”，其中包含原始页面和图片位置，但原始文章的文本已布局在它们周围。</p></li>
</ul>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/quickfox-image-no-go.py</span></code></p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/quickfox-image-no-go.pdf</span></code></p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/quickfox.zip</span></code></p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--2">英文</label><div class="tab-content docutils container">
<p>This is a demo script using PyMuPDF’s Story class to output text as a PDF with
a two-column page layout.</p>
<p>The script demonstrates the following features:</p>
<ul class="simple">
<li><p>Layout text around images of an existing (“target”) PDF.</p></li>
<li><p>Based on a few global parameters, areas on each page are identified, that</p></li>
</ul>
<p>can be used to receive text layouted by a Story.
* These global parameters are not stored anywhere in the target PDF and
must therefore be provided in some way:</p>
<ul class="simple">
<li><p>The width of the border(s) on each page.</p></li>
<li><dl class="simple">
<dt>The fontsize to use for text. This value determines whether the provided</dt><dd><p>text will fit in the empty spaces of the (fixed) pages of target PDF. It
cannot be predicted in any way. The script ends with an exception if
target PDF has not enough pages, and prints a warning message if not all
pages receive at least some text. In both cases, the FONTSIZE value
can be changed (a float value).</p>
</dd>
</dl>
</li>
<li><p>Use of a 2-column page layout for the text.</p></li>
</ul>
<ul class="simple">
<li><p>The layout creates a temporary (memory) PDF. Its produced page content</p></li>
</ul>
<p>(the text) is used to overlay the corresponding target page. If text
requires more pages than are available in target PDF, an exception is raised.
If not all target pages receive at least some text, a warning is printed.
* The script reads “image-no-go.pdf” in its own folder. This is the “target” PDF.
It contains 2 pages with each 2 images (from the original article), which are
positioned at places that create a broad overall test coverage. Otherwise the
pages are empty.
* The script produces “quickfox-image-no-go.pdf” which contains the original pages
and image positions, but with the original article text laid out around them.</p>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/quickfox-image-no-go.py</span></code></p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/quickfox-image-no-go.pdf</span></code></p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/quickfox.zip</span></code></p></li>
</ul>
</div>
</div>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is a demo script using PyMuPDF&#39;s Story class to output text as a PDF with</span>
<span class="sd">a two-column page layout.</span>

<span class="sd">The script demonstrates the following features:</span>
<span class="sd">* Layout text around images of an existing (&quot;target&quot;) PDF.</span>
<span class="sd">* Based on a few global parameters, areas on each page are identified, that</span>
<span class="sd">  can be used to receive text layouted by a Story.</span>
<span class="sd">* These global parameters are not stored anywhere in the target PDF and</span>
<span class="sd">  must therefore be provided in some way.</span>
<span class="sd">  - The width of the border(s) on each page.</span>
<span class="sd">  - The fontsize to use for text. This value determines whether the provided</span>
<span class="sd">    text will fit in the empty spaces of the (fixed) pages of target PDF. It</span>
<span class="sd">    cannot be predicted in any way. The script ends with an exception if</span>
<span class="sd">    target PDF has not enough pages, and prints a warning message if not all</span>
<span class="sd">    pages receive at least some text. In both cases, the FONTSIZE value</span>
<span class="sd">    can be changed (a float value).</span>
<span class="sd">  - Use of a 2-column page layout for the text.</span>
<span class="sd">* The layout creates a temporary (memory) PDF. Its produced page content</span>
<span class="sd">  (the text) is used to overlay the corresponding target page. If text</span>
<span class="sd">  requires more pages than are available in target PDF, an exception is raised.</span>
<span class="sd">  If not all target pages receive at least some text, a warning is printed.</span>
<span class="sd">* The script reads &quot;image-no-go.pdf&quot; in its own folder. This is the &quot;target&quot; PDF.</span>
<span class="sd">  It contains 2 pages with each 2 images (from the original article), which are</span>
<span class="sd">  positioned at places that create a broad overall test coverage. Otherwise the</span>
<span class="sd">  pages are empty.</span>
<span class="sd">* The script produces &quot;quickfox-image-no-go.pdf&quot; which contains the original pages</span>
<span class="sd">  and image positions, but with the original article text laid out around them.</span>

<span class="sd">Note:</span>
<span class="sd">--------------</span>
<span class="sd">This script version uses just image positions to derive &quot;No-Go areas&quot; for</span>
<span class="sd">layouting the text. Other PDF objects types are detectable by PyMuPDF and may</span>
<span class="sd">be taken instead or in addition, without influencing the layouting.</span>
<span class="sd">The following are candidates for other such &quot;No-Go areas&quot;. Each can be detected</span>
<span class="sd">and located by PyMuPDF:</span>
<span class="sd">* Annotations</span>
<span class="sd">* Drawings</span>
<span class="sd">* Existing text</span>

<span class="sd">--------------</span>
<span class="sd">The text and images are taken from the somewhat modified Wikipedia article</span>
<span class="sd">https://en.wikipedia.org/wiki/The_quick_brown_fox_jumps_over_the_lazy_dog.</span>
<span class="sd">--------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>


<span class="n">thisdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">myzip</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">thisdir</span><span class="p">,</span> <span class="s2">&quot;quickfox.zip&quot;</span><span class="p">))</span>

<span class="n">docname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">thisdir</span><span class="p">,</span> <span class="s2">&quot;image-no-go.pdf&quot;</span><span class="p">)</span>  <span class="c1"># &quot;no go&quot; input PDF file name</span>
<span class="n">outname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">thisdir</span><span class="p">,</span> <span class="s2">&quot;quickfox-image-no-go.pdf&quot;</span><span class="p">)</span>  <span class="c1"># output PDF file name</span>
<span class="n">BORDER</span> <span class="o">=</span> <span class="mi">36</span>  <span class="c1"># global parameter</span>
<span class="n">FONTSIZE</span> <span class="o">=</span> <span class="mf">12.5</span>  <span class="c1"># global parameter</span>
<span class="n">COLS</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># number of text columns, global parameter</span>


<span class="k">def</span><span class="w"> </span><span class="nf">analyze_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute MediaBox and rectangles on page that are free to receive text.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Assume a BORDER around the page, make 2 columns of the resulting</span>
<span class="sd">        sub-rectangle and extract the rectangles of all images on page.</span>
<span class="sd">        For demo purposes, the image rectangles are taken as &quot;NO-GO areas&quot;</span>
<span class="sd">        on the page when writing text with the Story.</span>
<span class="sd">        The function returns free areas for each of the columns.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (page.number, mediabox, CELLS), where CELLS is a list of free cells.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prect</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">rect</span>  <span class="c1"># page rectangle - will be our MEDIABOX later</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">prect</span> <span class="o">+</span> <span class="p">(</span><span class="n">BORDER</span><span class="p">,</span> <span class="n">BORDER</span><span class="p">,</span> <span class="o">-</span><span class="n">BORDER</span><span class="p">,</span> <span class="o">-</span><span class="n">BORDER</span><span class="p">)</span>
    <span class="n">TABLE</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">make_table</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">COLS</span><span class="p">)</span>

    <span class="c1"># extract rectangles covered by images on this page</span>
    <span class="n">IMG_RECTS</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>  <span class="c1"># image rects on page (sort top-left to bottom-right)</span>
        <span class="p">[</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">get_image_info</span><span class="p">()],</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">x0</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">free_cells</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return free areas in this column.&quot;&quot;&quot;</span>
        <span class="n">free_stripes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># y-value pairs wrapping a free area stripe</span>
        <span class="c1"># intersecting images: block complete intersecting column stripe</span>
        <span class="n">col_imgs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">b</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">IMG_RECTS</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">column</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">s_y0</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">y0</span>  <span class="c1"># top y-value of column</span>
        <span class="k">for</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="ow">in</span> <span class="n">col_imgs</span><span class="p">:</span>  <span class="c1"># an image stripe</span>
            <span class="k">if</span> <span class="n">y0</span> <span class="o">&gt;</span> <span class="n">s_y0</span> <span class="o">+</span> <span class="n">FONTSIZE</span><span class="p">:</span>  <span class="c1"># image starts below last free btm value</span>
                <span class="n">free_stripes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s_y0</span><span class="p">,</span> <span class="n">y0</span><span class="p">))</span>  <span class="c1"># store as free stripe</span>
            <span class="n">s_y0</span> <span class="o">=</span> <span class="n">y1</span>  <span class="c1"># start of next free stripe</span>

        <span class="k">if</span> <span class="n">s_y0</span> <span class="o">+</span> <span class="n">FONTSIZE</span> <span class="o">&lt;</span> <span class="n">column</span><span class="o">.</span><span class="n">y1</span><span class="p">:</span>  <span class="c1"># enough room to column bottom</span>
            <span class="n">free_stripes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s_y0</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">y1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">free_stripes</span> <span class="o">==</span> <span class="p">[]:</span>  <span class="c1"># covers &quot;no image in this column&quot;</span>
            <span class="n">free_stripes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">column</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">y1</span><span class="p">))</span>

        <span class="c1"># make available cells of this column</span>
        <span class="n">CELLS</span> <span class="o">=</span> <span class="p">[</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">free_stripes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">CELLS</span>

    <span class="c1"># collection of available Story rectangles on page</span>
    <span class="n">CELLS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">COLS</span><span class="p">):</span>
        <span class="n">CELLS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">free_cells</span><span class="p">(</span><span class="n">TABLE</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">prect</span><span class="p">,</span> <span class="n">CELLS</span>


<span class="n">HTML</span> <span class="o">=</span> <span class="n">myzip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;quickfox.html&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="c1"># --------------------------------------------------------------</span>
<span class="c1"># Make the Story object</span>
<span class="c1"># --------------------------------------------------------------</span>
<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">HTML</span><span class="p">)</span>

<span class="c1"># modify the DOM somewhat</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># access HTML body</span>
<span class="n">body</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>  <span class="c1"># and give it our font globally</span>

<span class="c1"># modify certain nodes</span>
<span class="n">para</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># find relevant nodes (here: paragraphs)</span>
<span class="k">while</span> <span class="n">para</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">para</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span>  <span class="c1"># method MUST be used for existing nodes</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">FONTSIZE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">para</span> <span class="o">=</span> <span class="n">para</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># we remove all image references, because the target PDF already has them</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="k">while</span> <span class="n">img</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">next_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">img</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">next_img</span>

<span class="n">page_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># contains MEDIABOX and free CELLS per page</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
    <span class="n">pno</span><span class="p">,</span> <span class="n">mediabox</span><span class="p">,</span> <span class="n">cells</span> <span class="o">=</span> <span class="n">analyze_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">page_info</span><span class="p">[</span><span class="n">pno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mediabox</span><span class="p">,</span> <span class="n">cells</span><span class="p">)</span>
<span class="n">doc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close target PDF for now - re-open later</span>

<span class="n">fileobject</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>  <span class="c1"># let DocumentWriter write to memory</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="n">fileobject</span><span class="p">)</span>  <span class="c1"># define output writer</span>

<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># stop if this ever becomes zero</span>
<span class="n">pno</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># count output pages</span>
<span class="k">while</span> <span class="n">more</span><span class="p">:</span>  <span class="c1"># loop until all HTML text has been written</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">MEDIABOX</span><span class="p">,</span> <span class="n">CELLS</span> <span class="o">=</span> <span class="n">page_info</span><span class="p">[</span><span class="n">pno</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># too much text space required: reduce fontsize?</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;text does not fit on target PDF&quot;</span><span class="p">)</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>  <span class="c1"># prepare a new output page</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">CELLS</span><span class="p">:</span>  <span class="c1"># iterate over free cells on this page</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">more</span><span class="p">:</span>  <span class="c1"># need to check this for every cell</span>
            <span class="k">continue</span>
        <span class="n">more</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>  <span class="c1"># finish the PDF page</span>
    <span class="n">pno</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close DocumentWriter output</span>

<span class="c1"># Re-open writer output, read its pages and overlay target pages with them.</span>
<span class="c1"># The generated pages have same dimension as their targets.</span>
<span class="n">src</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">fileobject</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>  <span class="c1"># overlay every target page with the prepared text</span>
    <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="n">src</span><span class="o">.</span><span class="n">page_count</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Text only uses </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">page_count</span><span class="si">}</span><span class="s2"> target pages!&quot;</span><span class="p">)</span>
        <span class="k">continue</span>  <span class="c1"># story did not need all target pages?</span>

    <span class="c1"># overlay target page</span>
    <span class="n">page</span><span class="o">.</span><span class="n">show_pdf_page</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

    <span class="c1"># DEBUG start --- draw the text rectangles</span>
    <span class="c1"># mb, cells = page_info[page.number]</span>
    <span class="c1"># for cell in cells:</span>
    <span class="c1">#     page.draw_rect(cell, color=(1, 0, 0))</span>
    <span class="c1"># DEBUG stop ---</span>

<span class="n">doc</span><span class="o">.</span><span class="n">ez_save</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span>
</pre></div>
</div>
<p></details></p>
<hr class="docutils" />
</section>
<section id="html">
<span id="recipesstories-h"></span><h2>如何输出 HTML 表格<a class="headerlink" href="#html" title="此标题的永久链接">#</a></h2>
<p>How to Output an HTML Table</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">中文</label><div class="tab-content docutils container">
<p>支持输出 HTML 表格，如下所示：</p>
<ul class="simple">
<li><p>支持平面表格布局（”行 x 列”），不支持 “colspan” / “rowspan” 属性。</p></li>
<li><p>表头标签 <em class="htmltag">th</em> 支持 “scope” 属性，其值可以是 “row” 或 “col”。适用的文本默认加粗。</p></li>
<li><p>列宽度基于列内容自动计算，不能直接设置。</p></li>
<li><p>表格 <strong>单元格可以包含图片</strong> ，这些图片会被考虑在列宽计算中。</p></li>
<li><p>行高基于行内容自动计算 - 必要时会生成多行行。</p></li>
<li><p>表格行中的多行始终会保持在同一页（或 “where” 矩形区域）内，而不会被拆分。</p></li>
<li><p>表头行仅在第一页 / “where” 矩形区域显示。</p></li>
<li><p>在 HTML 表格元素中直接给出的 “style” 属性会被忽略。表格及其元素的样式必须在 CSS 源中或在 <em class="htmltag">style</em> 标签内定义。</p></li>
<li><p>不支持并会忽略 <em class="htmltag">tr</em> 元素的样式。因此，不支持表格的网格或交替行背景颜色。不过，以下示例脚本展示了如何解决此限制。</p></li>
</ul>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/table01.py</span></code> 该脚本反映了基本特性。</p></li>
</ul>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demo script for basic HTML table support in Story objects</span>

<span class="sd">Outputs a table with three columns that fits on one Letter page.</span>
<span class="sd">The content of each row is filled via the Story&#39;s template mechanism.</span>
<span class="sd">Column widths and row heights are automatically computed by MuPDF.</span>
<span class="sd">Some styling via a CSS source is also demonstrated:</span>

<span class="sd">- The table header row has a gray background</span>
<span class="sd">- Each cell shows a border at its top</span>
<span class="sd">- The Story&#39;s body uses the sans-serif font family</span>
<span class="sd">- The text of one of the columns is set to blue</span>

<span class="sd">Dependencies</span>
<span class="sd">-------------</span>
<span class="sd">PyMuPDF v1.22.0 or later</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">table_text</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># the content of each table row</span>
    <span class="p">(</span>
        <span class="s2">&quot;Length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Required) The number of bytes from the beginning of the line following the keyword stream to the last byte just before the keyword endstream. (There may be an additional EOL marker, preceding endstream, that is not included in the count and is not logically part of the stream data.) See “Stream Extent,” above, for further discussion.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;Filter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name or array&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional) The name of a filter to be applied in processing the stream data found between the keywords stream and endstream, or an array of such names. Multiple filters should be specified in the order in which they are to be applied.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;FFilter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name or array&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional; PDF 1.2) The name of a filter to be applied in processing the data found in the stream&#39;s external file, or an array of such names. The same rules apply as for Filter.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;FDecodeParms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dictionary or array&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional; PDF 1.2) A parameter dictionary, or an array of such dictionaries, used by the filters specified by FFilter. The same rules apply as for DecodeParms.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;DecodeParms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dictionary or array&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional) A parameter dictionary or an array of such dictionaries, used by the filters specified by Filter. If there is only one filter and that filter has parameters, DecodeParms must be set to the filter&#39;s parameter dictionary unless all the filter&#39;s parameters have their default values, in which case the DecodeParms entry may be omitted. If there are multiple filters and any of the filters has parameters set to nondefault values, DecodeParms must be an array with one entry for each filter: either the parameter dictionary for that filter, or the null object if that filter has no parameters (or if all of its parameters have their default values). If none of the filters have parameters, or if all their parameters have default values, the DecodeParms entry may be omitted. (See implementation note 7 in Appendix H.)&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;DL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional; PDF 1.5) A non-negative integer representing the number of bytes in the decoded (defiltered) stream. It can be used to determine, for example, whether enough disk space is available to write a stream to a file.\nThis value should be considered a hint only; for some stream filters, it may not be possible to determine this value precisely.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;F&quot;</span><span class="p">,</span>
        <span class="s2">&quot;file specification&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional; PDF 1.2) The file containing the stream data. If this entry is present, the bytes between stream and endstream are ignored, the filters are specified by FFilter rather than Filter, and the filter parameters are specified by FDecodeParms rather than DecodeParms. However, the Length entry should still specify the number of those bytes. (Usually, there are no bytes and Length is 0.) (See implementation note 46 in Appendix H.)&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Only a minimal HTML source is required to provide the Story&#39;s working</span>
<span class="n">HTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">&lt;body&gt;&lt;h2&gt;TABLE 3.4 Entries common to all stream dictionaries&lt;/h2&gt;</span>
<span class="s2">&lt;table&gt;</span>
<span class="s2">    &lt;tr&gt;</span>
<span class="s2">        &lt;th&gt;KEY&lt;/th&gt;&lt;th&gt;TYPE&lt;/th&gt;&lt;th&gt;VALUE&lt;/th&gt;</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">    &lt;tr id=&quot;row&quot;&gt;</span>
<span class="s2">        &lt;td id=&quot;col0&quot;&gt;&lt;/td&gt;&lt;td id=&quot;col1&quot;&gt;&lt;/td&gt;&lt;td id=&quot;col2&quot;&gt;&lt;/td&gt;</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">---------------------------------------------------------------------</span>
<span class="sd">Just for demo purposes, set:</span>
<span class="sd">- header cell background to gray</span>
<span class="sd">- text color in col1 to blue</span>
<span class="sd">- a border line at the top of all table cells</span>
<span class="sd">- all text to the sans-serif font</span>
<span class="sd">---------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;th {</span>
<span class="s2">    background-color: #aaa;</span>
<span class="s2">}</span>

<span class="s2">td[id=&quot;col1&quot;] {</span>
<span class="s2">    color: blue;</span>
<span class="s2">}</span>

<span class="s2">td, tr {</span>
<span class="s2">    border: 1px solid black;</span>
<span class="s2">    border-right-width: 0px;</span>
<span class="s2">    border-left-width: 0px;</span>
<span class="s2">    border-bottom-width: 0px;</span>
<span class="s2">}</span>
<span class="s2">body {</span>
<span class="s2">    font-family: sans-serif;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">HTML</span><span class="p">,</span> <span class="n">user_css</span><span class="o">=</span><span class="n">CSS</span><span class="p">)</span>  <span class="c1"># define the Story</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># access the HTML &lt;body&gt; of it</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;row&quot;</span><span class="p">)</span>  <span class="c1"># find the template with name &quot;row&quot;</span>
<span class="n">parent</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">parent</span>  <span class="c1"># access its parent i.e., the &lt;table&gt;</span>

<span class="k">for</span> <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="ow">in</span> <span class="n">table_text</span><span class="p">:</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>  <span class="c1"># make a clone of the row template</span>
    <span class="c1"># add text to each cell in the duplicated row</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;col0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">col0</span><span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;col1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">col1</span><span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;col2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">col2</span><span class="p">)</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>  <span class="c1"># add new row to &lt;table&gt;</span>
<span class="n">template</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># remove the template</span>

<span class="c1"># Story is ready - output it via a writer</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">),</span> <span class="s2">&quot;compress&quot;</span><span class="p">)</span>
<span class="n">mediabox</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>  <span class="c1"># size of one output page</span>
<span class="n">where</span> <span class="o">=</span> <span class="n">mediabox</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>  <span class="c1"># use this sub-area for the content</span>

<span class="n">more</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># detects end of output</span>
<span class="k">while</span> <span class="n">more</span><span class="p">:</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">mediabox</span><span class="p">)</span>  <span class="c1"># start a page, returning a device</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">filled</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>  <span class="c1"># compute content fitting into &quot;where&quot;</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>  <span class="c1"># output it to the page</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>  <span class="c1"># finalize the page</span>
<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close the output</span>
</pre></div>
</div>
<p></details></p>
<ul>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/national-capitals.py</span></code> 高级脚本使用简单的附加代码扩展表格输出选项：</p>
<blockquote>
<div><ul class="simple">
<li><p>多页输出模拟 <strong>重复标题行</strong></p></li>
<li><p>交替表格行背景颜色</p></li>
<li><p>表格行和列由网格线分隔</p></li>
<li><p>表格行动态生成/填充来自 SQL 数据库的数据</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--2">英文</label><div class="tab-content docutils container">
<p>Outputting HTML tables is supported as follows:</p>
<ul class="simple">
<li><p>Flat table layouts are supported (“rows x columns”), no support of the “colspan” / “rowspan” attributes.</p></li>
<li><p>Table header tag <em class="htmltag">th</em> supports attribute “scope” with values “row” or “col”. Applicable text will be bold by default.</p></li>
<li><p>Column widths are computed automatically based on column content. They cannot be directly set.</p></li>
<li><p>Table <strong>cells may contain images</strong> which will be considered in the column width calculation magic.</p></li>
<li><p>Row heights are computed automatically based on row content - leading to multi-line rows where needed.</p></li>
<li><p>The potentially multiple lines of a table row will always be kept together on one page (respectively “where” rectangle) and not be split.</p></li>
<li><p>Table header rows are only <strong>shown on the first page / “where” rectangle.</strong></p></li>
<li><p>The “style” attribute is ignored when given directly in HTML table elements. Styling for a table and its elements must happen separately, in CSS source or within the <em class="htmltag">style</em> tag.</p></li>
<li><p>Styling for <em class="htmltag">tr</em> elements is not supported and ignored. Therefore, a table-wide grid or alternating row background colors are not supported. One of the following example scripts however shows an easy way to deal with this limitation.</p></li>
</ul>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/table01.py</span></code> This script reflects basic features.</p></li>
</ul>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demo script for basic HTML table support in Story objects</span>

<span class="sd">Outputs a table with three columns that fits on one Letter page.</span>
<span class="sd">The content of each row is filled via the Story&#39;s template mechanism.</span>
<span class="sd">Column widths and row heights are automatically computed by MuPDF.</span>
<span class="sd">Some styling via a CSS source is also demonstrated:</span>

<span class="sd">- The table header row has a gray background</span>
<span class="sd">- Each cell shows a border at its top</span>
<span class="sd">- The Story&#39;s body uses the sans-serif font family</span>
<span class="sd">- The text of one of the columns is set to blue</span>

<span class="sd">Dependencies</span>
<span class="sd">-------------</span>
<span class="sd">PyMuPDF v1.22.0 or later</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">table_text</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># the content of each table row</span>
    <span class="p">(</span>
        <span class="s2">&quot;Length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Required) The number of bytes from the beginning of the line following the keyword stream to the last byte just before the keyword endstream. (There may be an additional EOL marker, preceding endstream, that is not included in the count and is not logically part of the stream data.) See “Stream Extent,” above, for further discussion.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;Filter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name or array&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional) The name of a filter to be applied in processing the stream data found between the keywords stream and endstream, or an array of such names. Multiple filters should be specified in the order in which they are to be applied.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;FFilter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name or array&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional; PDF 1.2) The name of a filter to be applied in processing the data found in the stream&#39;s external file, or an array of such names. The same rules apply as for Filter.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;FDecodeParms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dictionary or array&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional; PDF 1.2) A parameter dictionary, or an array of such dictionaries, used by the filters specified by FFilter. The same rules apply as for DecodeParms.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;DecodeParms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dictionary or array&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional) A parameter dictionary or an array of such dictionaries, used by the filters specified by Filter. If there is only one filter and that filter has parameters, DecodeParms must be set to the filter&#39;s parameter dictionary unless all the filter&#39;s parameters have their default values, in which case the DecodeParms entry may be omitted. If there are multiple filters and any of the filters has parameters set to nondefault values, DecodeParms must be an array with one entry for each filter: either the parameter dictionary for that filter, or the null object if that filter has no parameters (or if all of its parameters have their default values). If none of the filters have parameters, or if all their parameters have default values, the DecodeParms entry may be omitted. (See implementation note 7 in Appendix H.)&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;DL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional; PDF 1.5) A non-negative integer representing the number of bytes in the decoded (defiltered) stream. It can be used to determine, for example, whether enough disk space is available to write a stream to a file.\nThis value should be considered a hint only; for some stream filters, it may not be possible to determine this value precisely.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;F&quot;</span><span class="p">,</span>
        <span class="s2">&quot;file specification&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Optional; PDF 1.2) The file containing the stream data. If this entry is present, the bytes between stream and endstream are ignored, the filters are specified by FFilter rather than Filter, and the filter parameters are specified by FDecodeParms rather than DecodeParms. However, the Length entry should still specify the number of those bytes. (Usually, there are no bytes and Length is 0.) (See implementation note 46 in Appendix H.)&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Only a minimal HTML source is required to provide the Story&#39;s working</span>
<span class="n">HTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">&lt;body&gt;&lt;h2&gt;TABLE 3.4 Entries common to all stream dictionaries&lt;/h2&gt;</span>
<span class="s2">&lt;table&gt;</span>
<span class="s2">    &lt;tr&gt;</span>
<span class="s2">        &lt;th&gt;KEY&lt;/th&gt;&lt;th&gt;TYPE&lt;/th&gt;&lt;th&gt;VALUE&lt;/th&gt;</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">    &lt;tr id=&quot;row&quot;&gt;</span>
<span class="s2">        &lt;td id=&quot;col0&quot;&gt;&lt;/td&gt;&lt;td id=&quot;col1&quot;&gt;&lt;/td&gt;&lt;td id=&quot;col2&quot;&gt;&lt;/td&gt;</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">---------------------------------------------------------------------</span>
<span class="sd">Just for demo purposes, set:</span>
<span class="sd">- header cell background to gray</span>
<span class="sd">- text color in col1 to blue</span>
<span class="sd">- a border line at the top of all table cells</span>
<span class="sd">- all text to the sans-serif font</span>
<span class="sd">---------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;th {</span>
<span class="s2">    background-color: #aaa;</span>
<span class="s2">}</span>

<span class="s2">td[id=&quot;col1&quot;] {</span>
<span class="s2">    color: blue;</span>
<span class="s2">}</span>

<span class="s2">td, tr {</span>
<span class="s2">    border: 1px solid black;</span>
<span class="s2">    border-right-width: 0px;</span>
<span class="s2">    border-left-width: 0px;</span>
<span class="s2">    border-bottom-width: 0px;</span>
<span class="s2">}</span>
<span class="s2">body {</span>
<span class="s2">    font-family: sans-serif;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">HTML</span><span class="p">,</span> <span class="n">user_css</span><span class="o">=</span><span class="n">CSS</span><span class="p">)</span>  <span class="c1"># define the Story</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># access the HTML &lt;body&gt; of it</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;row&quot;</span><span class="p">)</span>  <span class="c1"># find the template with name &quot;row&quot;</span>
<span class="n">parent</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">parent</span>  <span class="c1"># access its parent i.e., the &lt;table&gt;</span>

<span class="k">for</span> <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="ow">in</span> <span class="n">table_text</span><span class="p">:</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>  <span class="c1"># make a clone of the row template</span>
    <span class="c1"># add text to each cell in the duplicated row</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;col0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">col0</span><span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;col1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">col1</span><span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;col2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">col2</span><span class="p">)</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>  <span class="c1"># add new row to &lt;table&gt;</span>
<span class="n">template</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># remove the template</span>

<span class="c1"># Story is ready - output it via a writer</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">),</span> <span class="s2">&quot;compress&quot;</span><span class="p">)</span>
<span class="n">mediabox</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>  <span class="c1"># size of one output page</span>
<span class="n">where</span> <span class="o">=</span> <span class="n">mediabox</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>  <span class="c1"># use this sub-area for the content</span>

<span class="n">more</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># detects end of output</span>
<span class="k">while</span> <span class="n">more</span><span class="p">:</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">mediabox</span><span class="p">)</span>  <span class="c1"># start a page, returning a device</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">filled</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>  <span class="c1"># compute content fitting into &quot;where&quot;</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>  <span class="c1"># output it to the page</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>  <span class="c1"># finalize the page</span>
<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close the output</span>
</pre></div>
</div>
<p></details></p>
<ul>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/national-capitals.py</span></code> Advanced script extending table output options using simple additional code:</p>
<blockquote>
<div><ul class="simple">
<li><p>Multi-page output simulating <strong>repeating header rows</strong></p></li>
<li><p>Alternating table row background colors</p></li>
<li><p>Table rows and columns delimited by gridlines</p></li>
<li><p>Table rows dynamically generated / filled with data from an SQL database</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
</div>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demo script using (Py-) MuPDF &quot;Story&quot; feature.</span>

<span class="sd">The following features are implemented:</span>

<span class="sd">* Use of Story &quot;template&quot; feature to provide row content</span>
<span class="sd">* Use database access (SQLITE) to fetch row content</span>
<span class="sd">* Use ElementPosition feature to locate cell positions on page</span>
<span class="sd">* Simulate feature &quot;Table Header Repeat&quot;</span>
<span class="sd">* Simulate feature &quot;Cell Grid Lines&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Table data. Used to populate a temporary SQL database, which will be processed by the script.</span>
<span class="sd">Its only purpose is to avoid carrying around a separate database file.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># codespell:ignore-begin</span>
<span class="n">table_data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;China;Beijing;21542000;1.5%;2018</span>
<span class="s2">Japan;Tokyo;13921000;11.2%;2019</span>
<span class="s2">DR Congo;Kinshasa;12691000;13.2%;2017</span>
<span class="s2">Russia;Moscow;12655050;8.7%;2021</span>
<span class="s2">Indonesia;Jakarta;10562088;3.9%;2020</span>
<span class="s2">Egypt;Cairo;10107125;9.3%;2022</span>
<span class="s2">South Korea;Seoul;9508451;18.3%;2022</span>
<span class="s2">Mexico;Mexico City;9209944;7.3%;2020</span>
<span class="s2">United Kingdom;London;9002488;13.4%;2020</span>
<span class="s2">Bangladesh;Dhaka;8906039;5.3%;2011</span>
<span class="s2">Peru;Lima;8852000;26.3%;2012</span>
<span class="s2">Iran;Tehran;8693706;9.9%;2016</span>
<span class="s2">Thailand;Bangkok;8305218;11.6%;2010</span>
<span class="s2">Vietnam;Hanoi;8053663;8.3%;2019</span>
<span class="s2">Iraq;Baghdad;7682136;17.6%;2021</span>
<span class="s2">Saudi Arabia;Riyadh;7676654;21.4%;2018</span>
<span class="s2">Hong Kong;Hong Kong;7291600;100%;2022</span>
<span class="s2">Colombia;Bogotá;7181469;13.9%;2011</span>
<span class="s2">Chile;Santiago;6310000;32.4%;2012</span>
<span class="s2">Turkey;Ankara;5747325;6.8%;2021</span>
<span class="s2">Singapore;Singapore;5453600;91.8%;2021</span>
<span class="s2">Afghanistan;Kabul;4601789;11.5%;2021</span>
<span class="s2">Kenya;Nairobi;4397073;8.3%;2019</span>
<span class="s2">Jordan;Amman;4061150;36.4%;2021</span>
<span class="s2">Algeria;Algiers;3915811;8.9%;2011</span>
<span class="s2">Germany;Berlin;3677472;4.4%;2021</span>
<span class="s2">Spain;Madrid;3305408;7.0%;2021</span>
<span class="s2">Ethiopia;Addis Ababa;3040740;2.5%;2012</span>
<span class="s2">Kuwait;Kuwait City;2989000;70.3%;2018</span>
<span class="s2">Guatemala;Guatemala City;2934841;16.7%;2020</span>
<span class="s2">South Africa;Pretoria;2921488;4.9%;2011</span>
<span class="s2">Ukraine;Kyiv;2920873;6.7%;2021</span>
<span class="s2">Argentina;Buenos Aires;2891082;6.4%;2010</span>
<span class="s2">North Korea;Pyongyang;2870000;11.1%;2016</span>
<span class="s2">Uzbekistan;Tashkent;2860600;8.4%;2022</span>
<span class="s2">Italy;Rome;2761632;4.7%;2022</span>
<span class="s2">Ecuador;Quito;2800388;15.7%;2020</span>
<span class="s2">Cameroon;Yaoundé;2765568;10.2%;2015</span>
<span class="s2">Zambia;Lusaka;2731696;14.0%;2020</span>
<span class="s2">Sudan;Khartoum;2682431;5.9%;2012</span>
<span class="s2">Brazil;Brasília;2648532;1.2%;2012</span>
<span class="s2">Taiwan;Taipei (de facto);2608332;10.9%;2020</span>
<span class="s2">Yemen;Sanaa;2575347;7.8%;2012</span>
<span class="s2">Angola;Luanda;2571861;7.5%;2020</span>
<span class="s2">Burkina Faso;Ouagadougou;2453496;11.1%;2019</span>
<span class="s2">Ghana;Accra;2388000;7.3%;2017</span>
<span class="s2">Somalia;Mogadishu;2388000;14.0%;2021</span>
<span class="s2">Azerbaijan;Baku;2303100;22.3%;2022</span>
<span class="s2">Cambodia;Phnom Penh;2281951;13.8%;2019</span>
<span class="s2">Venezuela;Caracas;2245744;8.0%;2016</span>
<span class="s2">France;Paris;2139907;3.3%;2022</span>
<span class="s2">Cuba;Havana;2132183;18.9%;2020</span>
<span class="s2">Zimbabwe;Harare;2123132;13.3%;2012</span>
<span class="s2">Syria;Damascus;2079000;9.7%;2019</span>
<span class="s2">Belarus;Minsk;1996553;20.8%;2022</span>
<span class="s2">Austria;Vienna;1962779;22.0%;2022</span>
<span class="s2">Poland;Warsaw;1863056;4.9%;2021</span>
<span class="s2">Philippines;Manila;1846513;1.6%;2020</span>
<span class="s2">Mali;Bamako;1809106;8.3%;2009</span>
<span class="s2">Malaysia;Kuala Lumpur;1782500;5.3%;2019</span>
<span class="s2">Romania;Bucharest;1716983;8.9%;2021</span>
<span class="s2">Hungary;Budapest;1706851;17.6%;2022</span>
<span class="s2">Congo;Brazzaville;1696392;29.1%;2015</span>
<span class="s2">Serbia;Belgrade;1688667;23.1%;2021</span>
<span class="s2">Uganda;Kampala;1680600;3.7%;2019</span>
<span class="s2">Guinea;Conakry;1660973;12.3%;2014</span>
<span class="s2">Mongolia;Ulaanbaatar;1466125;43.8%;2020</span>
<span class="s2">Honduras;Tegucigalpa;1444085;14.0%;2021</span>
<span class="s2">Senegal;Dakar;1438725;8.5%;2021</span>
<span class="s2">Niger;Niamey;1334984;5.3%;2020</span>
<span class="s2">Uruguay;Montevideo;1319108;38.5%;2011</span>
<span class="s2">Bulgaria;Sofia;1307439;19.0%;2021</span>
<span class="s2">Oman;Muscat;1294101;28.6%;2021</span>
<span class="s2">Czech Republic;Prague;1275406;12.1%;2022</span>
<span class="s2">Madagascar;Antananarivo;1275207;4.4%;2018</span>
<span class="s2">Kazakhstan;Astana;1239900;6.5%;2022</span>
<span class="s2">Nigeria;Abuja;1235880;0.6%;2011</span>
<span class="s2">Georgia;Tbilisi;1201769;32.0%;2022</span>
<span class="s2">Mauritania;Nouakchott;1195600;25.9%;2019</span>
<span class="s2">Qatar;Doha;1186023;44.1%;2020</span>
<span class="s2">Libya;Tripoli;1170000;17.4%;2019</span>
<span class="s2">Myanmar;Naypyidaw;1160242;2.2%;2014</span>
<span class="s2">Rwanda;Kigali;1132686;8.4%;2012</span>
<span class="s2">Mozambique;Maputo;1124988;3.5%;2020</span>
<span class="s2">Dominican Republic;Santo Domingo;1111838;10.0%;2010</span>
<span class="s2">Armenia;Yerevan;1096100;39.3%;2021</span>
<span class="s2">Kyrgyzstan;Bishkek;1074075;16.5%;2021</span>
<span class="s2">Sierra Leone;Freetown;1055964;12.5%;2015</span>
<span class="s2">Nicaragua;Managua;1055247;15.4%;2020</span>
<span class="s2">Canada;Ottawa;1017449;2.7%;2021</span>
<span class="s2">Pakistan;Islamabad;1014825;0.4%;2017</span>
<span class="s2">Liberia;Monrovia;1010970;19.5%;2008</span>
<span class="s2">United Arab Emirates;Abu Dhabi;1010092;10.8%;2020</span>
<span class="s2">Malawi;Lilongwe;989318;5.0%;2018</span>
<span class="s2">Haiti;Port-au-Prince;987310;8.6%;2015</span>
<span class="s2">Sweden;Stockholm;978770;9.4%;2021</span>
<span class="s2">Eritrea;Asmara;963000;26.6%;2020</span>
<span class="s2">Israel;Jerusalem;936425;10.5%;2019</span>
<span class="s2">Laos;Vientiane;927724;12.5%;2019</span>
<span class="s2">Chad;N&#39;Djamena;916000;5.3%;2009</span>
<span class="s2">Netherlands;Amsterdam;905234;5.2%;2022</span>
<span class="s2">Central African Republic;Bangui;889231;16.3%;2020</span>
<span class="s2">Panama;Panama City;880691;20.2%;2013</span>
<span class="s2">Tajikistan;Dushanbe;863400;8.9%;2020</span>
<span class="s2">Nepal;Kathmandu;845767;2.8%;2021</span>
<span class="s2">Togo;Lomé;837437;9.7%;2010</span>
<span class="s2">Turkmenistan;Ashgabat;791000;12.5%;2017</span>
<span class="s2">Moldova;Chişinău;779300;25.5%;2019</span>
<span class="s2">Croatia;Zagreb;769944;19.0%;2021</span>
<span class="s2">Gabon;Libreville;703904;30.1%;2013</span>
<span class="s2">Norway;Oslo;697010;12.9%;2021</span>
<span class="s2">Macau;Macau;671900;97.9%;2022</span>
<span class="s2">United States;Washington D.C.;670050;0.2%;2021</span>
<span class="s2">Jamaica;Kingston;662491;23.4%;2019</span>
<span class="s2">Finland;Helsinki;658864;11.9%;2021</span>
<span class="s2">Tunisia;Tunis;638845;5.2%;2014</span>
<span class="s2">Denmark;Copenhagen;638117;10.9%;2021</span>
<span class="s2">Greece;Athens;637798;6.1%;2021</span>
<span class="s2">Latvia;Riga;605802;32.3%;2021</span>
<span class="s2">Djibouti;Djibouti (city);604013;54.6%;2012</span>
<span class="s2">Ireland;Dublin;588233;11.8%;2022</span>
<span class="s2">Morocco;Rabat;577827;1.6%;2014</span>
<span class="s2">Lithuania;Vilnius;576195;20.7%;2022</span>
<span class="s2">El Salvador;San Salvador;570459;9.0%;2019</span>
<span class="s2">Albania;Tirana;557422;19.5%;2011</span>
<span class="s2">North Macedonia;Skopje;544086;25.9%;2015</span>
<span class="s2">South Sudan;Juba;525953;4.9%;2017</span>
<span class="s2">Paraguay;Asunción;521559;7.8%;2020</span>
<span class="s2">Portugal;Lisbon;509614;5.0%;2020</span>
<span class="s2">Guinea-Bissau;Bissau;492004;23.9%;2015</span>
<span class="s2">Slovakia;Bratislava;440948;8.1%;2020</span>
<span class="s2">Estonia;Tallinn;438341;33.0%;2021</span>
<span class="s2">Australia;Canberra;431380;1.7%;2020</span>
<span class="s2">Namibia;Windhoek;431000;17.0%;2020</span>
<span class="s2">Tanzania;Dodoma;410956;0.6%;2012</span>
<span class="s2">Papua New Guinea;Port Moresby;364145;3.7%;2011</span>
<span class="s2">Ivory Coast;Yamoussoukro;361893;1.3%;2020</span>
<span class="s2">Lebanon;Beirut;361366;6.5%;2014</span>
<span class="s2">Bolivia;Sucre;360544;3.0%;2022</span>
<span class="s2">Puerto Rico (US);San Juan;342259;10.5%;2020</span>
<span class="s2">Costa Rica;San José;342188;6.6%;2018</span>
<span class="s2">Lesotho;Maseru;330760;14.5%;2016</span>
<span class="s2">Cyprus;Nicosia;326739;26.3%;2016</span>
<span class="s2">Equatorial Guinea;Malabo;297000;18.2%;2018</span>
<span class="s2">Slovenia;Ljubljana;285604;13.5%;2021</span>
<span class="s2">East Timor;Dili;277279;21.0%;2015</span>
<span class="s2">Bosnia and Herzegovina;Sarajevo;275524;8.4%;2013</span>
<span class="s2">Bahamas;Nassau;274400;67.3%;2016</span>
<span class="s2">Botswana;Gaborone;273602;10.6%;2020</span>
<span class="s2">Benin;Porto-Novo;264320;2.0%;2013</span>
<span class="s2">Suriname;Paramaribo;240924;39.3%;2012</span>
<span class="s2">India;New Delhi;249998;0.0%;2011</span>
<span class="s2">Sahrawi Arab Democratic Republic;Laayoune (claimed) - Tifariti (de facto);217732 - 3000;—;2014</span>
<span class="s2">New Zealand;Wellington;217000;4.2%;2021</span>
<span class="s2">Bahrain;Manama;200000;13.7%;2020</span>
<span class="s2">Kosovo;Pristina;198897;12.0%;2011</span>
<span class="s2">Montenegro;Podgorica;190488;30.3%;2020</span>
<span class="s2">Belgium;Brussels;187686;1.6%;2022</span>
<span class="s2">Cape Verde;Praia;159050;27.1%;2017</span>
<span class="s2">Mauritius;Port Louis;147066;11.3%;2018</span>
<span class="s2">Curaçao (Netherlands);Willemstad;136660;71.8%;2011</span>
<span class="s2">Burundi;Gitega;135467;1.1%;2020</span>
<span class="s2">Switzerland;Bern (de facto);134591;1.5%;2020</span>
<span class="s2">Transnistria;Tiraspol;133807;38.5%;2015</span>
<span class="s2">Maldives;Malé;133412;25.6%;2014</span>
<span class="s2">Iceland;Reykjavík;133262;36.0%;2021</span>
<span class="s2">Luxembourg;Luxembourg City;124509;19.5%;2021</span>
<span class="s2">Guyana;Georgetown;118363;14.7%;2012</span>
<span class="s2">Bhutan;Thimphu;114551;14.7%;2017</span>
<span class="s2">Comoros;Moroni;111326;13.5%;2016</span>
<span class="s2">Barbados;Bridgetown;110000;39.1%;2014</span>
<span class="s2">Sri Lanka;Sri Jayawardenepura Kotte;107925;0.5%;2012</span>
<span class="s2">Brunei;Bandar Seri Begawan;100700;22.6%;2007</span>
<span class="s2">Eswatini;Mbabane;94874;8.0%;2010</span>
<span class="s2">New Caledonia (France);Nouméa;94285;32.8%;2019</span>
<span class="s2">Fiji;Suva;93970;10.2%;2017</span>
<span class="s2">Solomon Islands;Honiara;92344;13.0%;2021</span>
<span class="s2">Republic of Artsakh;Stepanakert;75000;62.5%;2021</span>
<span class="s2">Gambia;Banjul;73000;2.8%;2013</span>
<span class="s2">São Tomé and Príncipe;São Tomé;71868;32.2%;2015</span>
<span class="s2">Kiribati;Tarawa;70480;54.7%;2020</span>
<span class="s2">Vanuatu;Port Vila;51437;16.1%;2016</span>
<span class="s2">Northern Mariana Islands (USA);Saipan;47565;96.1%;2017</span>
<span class="s2">Samoa;Apia;41611;19.0%;2021</span>
<span class="s2">Palestine;Ramallah (de facto);38998;0.8%;2017</span>
<span class="s2">Monaco;Monaco;38350;104.5%;2020</span>
<span class="s2">Jersey (UK);Saint Helier;37540;34.2%;2018</span>
<span class="s2">Trinidad and Tobago;Port of Spain;37074;2.4%;2011</span>
<span class="s2">Cayman Islands (UK);George Town;34399;50.5%;2021</span>
<span class="s2">Gibraltar (UK);Gibraltar;34003;104.1%;2020</span>
<span class="s2">Grenada;St. George&#39;s;33734;27.1%;2012</span>
<span class="s2">Aruba (Netherlands);Oranjestad;28294;26.6%;2010</span>
<span class="s2">Isle of Man (UK);Douglas;27938;33.2%;2011</span>
<span class="s2">Marshall Islands;Majuro;27797;66.1%;2011</span>
<span class="s2">Tonga;Nukuʻalofa;27600;26.0%;2022</span>
<span class="s2">Seychelles;Victoria;26450;24.8%;2010</span>
<span class="s2">French Polynesia (France);Papeete;26926;8.9%;2017</span>
<span class="s2">Andorra;Andorra la Vella;22873;28.9%;2022</span>
<span class="s2">Faroe Islands (Denmark);Tórshavn;22738;43.0%;2022</span>
<span class="s2">Antigua and Barbuda;St. John&#39;s;22219;23.8%;2011</span>
<span class="s2">Belize;Belmopan;20621;5.2%;2016</span>
<span class="s2">Saint Lucia;Castries;20000;11.1%;2013</span>
<span class="s2">Guernsey (UK);Saint Peter Port;18958;30.1%;2019</span>
<span class="s2">Greenland (Denmark);Nuuk;18800;33.4%;2021</span>
<span class="s2">Dominica;Roseau;14725;20.3%;2011</span>
<span class="s2">Saint Kitts and Nevis;Basseterre;14000;29.4%;2018</span>
<span class="s2">Saint Vincent and the Grenadines;Kingstown;12909;12.4%;2012</span>
<span class="s2">British Virgin Islands (UK);Road Town;12603;40.5%;2012</span>
<span class="s2">Åland (Finland);Mariehamn;11736;39.0%;2021</span>
<span class="s2">U.S. Virgin Islands (US);Charlotte Amalie;14477;14.5%;2020</span>
<span class="s2">Micronesia;Palikir;6647;5.9%;2010</span>
<span class="s2">Tuvalu;Funafuti;6320;56.4%;2017</span>
<span class="s2">Malta;Valletta;5827;1.1%;2019</span>
<span class="s2">Liechtenstein;Vaduz;5774;14.8%;2021</span>
<span class="s2">Saint Pierre and Miquelon (France);Saint-Pierre;5394;91.7%;2019</span>
<span class="s2">Cook Islands (NZ);Avarua;4906;28.9%;2016</span>
<span class="s2">San Marino;City of San Marino;4061;12.0%;2021</span>
<span class="s2">Turks and Caicos Islands (UK);Cockburn Town;3720;8.2%;2016</span>
<span class="s2">American Samoa (USA);Pago Pago;3656;8.1%;2010</span>
<span class="s2">Saint Martin (France);Marigot;3229;10.1%;2017</span>
<span class="s2">Saint Barthélemy (France);Gustavia;2615;24.1%;2010</span>
<span class="s2">Falkland Islands (UK);Stanley;2460;65.4%;2016</span>
<span class="s2">Svalbard (Norway);Longyearbyen;2417;82.2%;2020</span>
<span class="s2">Sint Maarten (Netherlands);Philipsburg;1894;4.3%;2011</span>
<span class="s2">Christmas Island (Australia);Flying Fish Cove;1599;86.8%;2016</span>
<span class="s2">Anguilla (UK);The Valley;1067;6.8%;2011</span>
<span class="s2">Guam (US);Hagåtña;1051;0.6%;2010</span>
<span class="s2">Wallis and Futuna (France);Mata Utu;1029;8.9%;2018</span>
<span class="s2">Bermuda (UK);Hamilton;854;1.3%;2016</span>
<span class="s2">Nauru;Yaren (de facto);747;6.0%;2011</span>
<span class="s2">Saint Helena (UK);Jamestown;629;11.6%;2016</span>
<span class="s2">Niue (NZ);Alofi;597;30.8%;2017</span>
<span class="s2">Tokelau (NZ);Atafu;541;29.3%;2016</span>
<span class="s2">Vatican City;Vatican City (city-state);453;100%;2019</span>
<span class="s2">Montserrat (UK);Brades (de facto) - Plymouth (de jure);449 - 0;-;2011</span>
<span class="s2">Norfolk Island (Australia);Kingston;341;-;2015</span>
<span class="s2">Palau;Ngerulmud;271;1.5%;2010</span>
<span class="s2">Cocos (Keeling) Islands (Australia);West Island;134;24.6%;2011</span>
<span class="s2">Pitcairn Islands (UK);Adamstown;40;100.0%;2021</span>
<span class="s2">South Georgia and the South Sandwich Islands (UK);King Edward Point;22;73.3%;2018&quot;&quot;&quot;</span>
<span class="c1"># codespell:ignore-end</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># HTML template for the report. We define no table header &lt;th&gt; items</span>
<span class="c1"># because this is done in post processing.</span>
<span class="c1"># The actual template part is the table row, identified by id &quot;row&quot;.</span>
<span class="c1"># The content of each cell will be filled using the respective id.</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">HTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;h1 style=&quot;text-align:center&quot;&gt;World Capital Cities&lt;/h1&gt;</span>
<span class="s2">    &lt;p&gt;&lt;i&gt;Percent &quot;%&quot; is city population as a percentage of the country, as of &quot;Year&quot;.&lt;/i&gt;</span>
<span class="s2">    &lt;/p&gt;&lt;p&gt;&lt;/p&gt;</span>
<span class="s2">    &lt;table&gt;</span>
<span class="s2">    &lt;tr id=&quot;row&quot;&gt;</span>
<span class="s2">        &lt;td id=&quot;country&quot;&gt;&lt;/td&gt;</span>
<span class="s2">        &lt;td id=&quot;capital&quot;&gt;&lt;/td&gt;</span>
<span class="s2">        &lt;td id=&quot;population&quot;&gt;&lt;/td&gt;</span>
<span class="s2">        &lt;td id=&quot;percent&quot;&gt;&lt;/td&gt;</span>
<span class="s2">        &lt;td id=&quot;year&quot;&gt;&lt;/td&gt;</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">    &lt;/table&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># Sets font-family globally to sans-serif, and text-align to right</span>
<span class="c1"># for the numerical table columns.</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">body {</span>
<span class="s2">    font-family: sans-serif;</span>
<span class="s2">}</span>
<span class="s2">td[id=&quot;population&quot;], td[id=&quot;percent&quot;], td[id=&quot;year&quot;] {</span>
<span class="s2">    text-align: right;</span>
<span class="s2">    padding-right: 2px;</span>
<span class="s2">}&quot;&quot;&quot;</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># recorder function for cell positions</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">coords</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># stores cell gridline coordinates</span>


<span class="k">def</span><span class="w"> </span><span class="nf">recorder</span><span class="p">(</span><span class="n">elpos</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;We only record positions of table rows and cells.</span>

<span class="sd">    Information is stored in &quot;coords&quot; with page number as key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">coords</span>  <span class="c1"># dictionary of row and cell coordinates per page</span>
    <span class="k">if</span> <span class="n">elpos</span><span class="o">.</span><span class="n">open_close</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># only consider coordinates provided at &quot;close&quot;</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">elpos</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;capital&quot;</span><span class="p">,</span> <span class="s2">&quot;population&quot;</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">):</span>
        <span class="k">return</span>  <span class="c1"># only look at row / cell content</span>

    <span class="n">rect</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">elpos</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span>  <span class="c1"># cell rectangle</span>
    <span class="k">if</span> <span class="n">rect</span><span class="o">.</span><span class="n">y1</span> <span class="o">&gt;</span> <span class="n">elpos</span><span class="o">.</span><span class="n">filled</span><span class="p">:</span>  <span class="c1"># ignore stuff below the filled rectangle</span>
        <span class="k">return</span>

    <span class="c1"># per page, we store the floats top-most y, right-most x, column left</span>
    <span class="c1"># and row bottom borders.</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">elpos</span><span class="o">.</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">elpos</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="s2">&quot;row&quot;</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>  <span class="c1"># add cell left border coordinate</span>
        <span class="k">if</span> <span class="n">rect</span><span class="o">.</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">x1</span><span class="p">:</span>  <span class="c1"># store right-most cell border on page</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">x1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>  <span class="c1"># add row bottom border coordinate</span>
        <span class="k">if</span> <span class="n">rect</span><span class="o">.</span><span class="n">y0</span> <span class="o">&lt;</span> <span class="n">y0</span><span class="p">:</span>  <span class="c1"># store top-most cell border per page</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">y0</span>

    <span class="n">coords</span><span class="p">[</span><span class="n">elpos</span><span class="o">.</span><span class="n">page</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>  <span class="c1"># write back info per page</span>
    <span class="k">return</span>


<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># define database access: make an intermediate memory database for</span>
<span class="c1"># our demo purposes.</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">dbfilename</span> <span class="o">=</span> <span class="s2">&quot;:memory:&quot;</span>  <span class="c1"># the SQLITE database file name</span>
<span class="n">database</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbfilename</span><span class="p">)</span>  <span class="c1"># open database</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>  <span class="c1"># multi-purpose database cursor</span>

<span class="c1"># Define and fill the SQLITE database</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CREATE TABLE capitals (Country text, Capital text, Population text, Percent text, Year text)&quot;&quot;&quot;</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">table_data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO capitals VALUES (?,?,?,?,?)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span>

<span class="c1"># select statement for the rows - let SQL also sort it for us</span>
<span class="n">select</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM capitals ORDER BY &quot;Country&quot; &quot;&quot;&quot;</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># define the HTML Story and fill it with database data</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">HTML</span><span class="p">,</span> <span class="n">user_css</span><span class="o">=</span><span class="n">CSS</span><span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># access the HTML body detail</span>

<span class="n">template</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;row&quot;</span><span class="p">)</span>  <span class="c1"># find the template part</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># find start of table</span>

<span class="c1"># read the rows from the database and put them all in one Python list</span>
<span class="c1"># NOTE: instead, we might fetch rows one by one (advisable for large volumes)</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>  <span class="c1"># execute cursor, and ...</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>  <span class="c1"># read out what was found</span>
<span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># no longer needed</span>

<span class="k">for</span> <span class="n">country</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>  <span class="c1"># iterate through the row</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>  <span class="c1"># clone the template to report each row</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;capital&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">capital</span><span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;population&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

    <span class="n">table</span><span class="o">.</span><span class="n">append_child</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="n">template</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># remove the template</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># generate the PDF and write it to memory</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="n">mediabox</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>  <span class="c1"># use pages in Letter format</span>
<span class="n">where</span> <span class="o">=</span> <span class="n">mediabox</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">72</span><span class="p">)</span>  <span class="c1"># leave page borders</span>
<span class="n">more</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">page</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">more</span><span class="p">:</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">mediabox</span><span class="p">)</span>  <span class="c1"># make a new page</span>
    <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># leave room above the cells for inserting header row</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">filled</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>  <span class="c1"># arrange content on this rectangle</span>
    <span class="n">story</span><span class="o">.</span><span class="n">element_positions</span><span class="p">(</span><span class="n">recorder</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span> <span class="s2">&quot;filled&quot;</span><span class="p">:</span> <span class="n">where</span><span class="o">.</span><span class="n">y1</span><span class="p">})</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>  <span class="c1"># write content to page</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>  <span class="c1"># finish the page</span>
    <span class="n">page</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close the PDF</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># re-open memory PDF for inserting gridlines and header rows</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
    <span class="n">page</span><span class="o">.</span><span class="n">wrap_contents</span><span class="p">()</span>  <span class="c1"># ensure all &quot;cm&quot; commands are properly wrapped</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">]</span>  <span class="c1"># read coordinates of the page</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">x1</span><span class="p">]</span>  <span class="c1"># list of cell left-right borders</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>  <span class="c1"># list of cell top-bottom borders</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">new_shape</span><span class="p">()</span>  <span class="c1"># make a canvas to draw upon</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">y</span><span class="p">:</span>  <span class="c1"># draw horizontal lines (one under each row)</span>
        <span class="n">shape</span><span class="o">.</span><span class="n">draw_line</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>  <span class="c1"># alternating row coloring</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">draw_rect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>  <span class="c1"># draw vertical lines</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">2</span>
        <span class="n">shape</span><span class="o">.</span><span class="n">draw_line</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># Write header row above table content</span>
    <span class="n">y0</span> <span class="o">-=</span> <span class="mi">5</span>  <span class="c1"># bottom coord for header row text</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y0</span><span class="p">),</span> <span class="s2">&quot;Country&quot;</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;hebo&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y0</span><span class="p">),</span> <span class="s2">&quot;Capital&quot;</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;hebo&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">y0</span><span class="p">),</span> <span class="s2">&quot;Population&quot;</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;hebo&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">y0</span><span class="p">),</span> <span class="s2">&quot;  %&quot;</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;hebo&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">y0</span><span class="p">),</span> <span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;hebo&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c1"># Write page footer</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">50</span>  <span class="c1"># top coordinate of footer bbox</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># footer bbox</span>
    <span class="n">page</span><span class="o">.</span><span class="n">insert_textbox</span><span class="p">(</span>
        <span class="n">bbox</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;World Capital Cities, Page </span><span class="si">{</span><span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">page_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">align</span><span class="o">=</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">TEXT_ALIGN_CENTER</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>  <span class="c1"># rectangles and gray lines</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">overlay</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># put the drawings in background</span>

<span class="n">doc</span><span class="o">.</span><span class="n">subset_fonts</span><span class="p">()</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">),</span> <span class="n">deflate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">garbage</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pretty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">doc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p></details></p>
<hr class="docutils" />
</section>
<section id="recipesstories-i">
<span id="id10"></span><h2>如何创建简单的网格布局<a class="headerlink" href="#recipesstories-i" title="此标题的永久链接">#</a></h2>
<p>How to Create a Simple Grid Layout</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">中文</label><div class="tab-content docutils container">
<p>通过在通过 <a class="reference internal" href="functions.html#functions-make-table"><span class="std std-ref">make_table</span></a> 函数创建的网格内创建 <a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a> 对象序列，开发人员可以根据需要创建网格布局。</p>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/simple-grid.py</span></code></p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">英文</label><div class="tab-content docutils container">
<p>By creating a sequence of <a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a> objects within a grid created via the <a class="reference internal" href="functions.html#functions-make-table"><span class="std std-ref">make_table</span></a> function a developer can create grid layouts as required.</p>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/simple-grid.py</span></code></p></li>
</ul>
</div>
</div>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>  <span class="c1"># output page format: Letter</span>
<span class="n">GRIDSPACE</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="n">GRID</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">make_table</span><span class="p">(</span><span class="n">GRIDSPACE</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">CELLS</span> <span class="o">=</span> <span class="p">[</span><span class="n">GRID</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">text_table</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">))</span>  <span class="c1"># create the writer</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>  <span class="c1"># make new page</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text_table</span><span class="p">):</span>
    <span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">em</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>
    <span class="k">with</span> <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span> <span class="k">as</span> <span class="n">para</span><span class="p">:</span>
        <span class="n">para</span><span class="o">.</span><span class="n">set_bgcolor</span><span class="p">(</span><span class="s2">&quot;#ecc&quot;</span><span class="p">)</span>
        <span class="n">para</span><span class="o">.</span><span class="n">set_pagebreak_after</span><span class="p">()</span>  <span class="c1"># fills whole cell with bgcolor</span>
        <span class="n">para</span><span class="o">.</span><span class="n">set_align</span><span class="p">(</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
        <span class="n">para</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">para</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">CELLS</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">story</span>

<span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>  <span class="c1"># finish page</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close output file</span>
</pre></div>
</div>
<p></details></p>
<hr class="docutils" />
</section>
<section id="recipesstories-j">
<span id="id11"></span><h2>如何生成目录<a class="headerlink" href="#recipesstories-j" title="此标题的永久链接">#</a></h2>
<p>How to Generate a Table of Contents</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">中文</label><div class="tab-content docutils container">
<p>此脚本列出了脚本目录中所有 Python 脚本的源代码。</p>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/code-printer.py</span></code></p></li>
</ul>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demo script PyMuPDF Story class</span>
<span class="sd">-------------------------------</span>

<span class="sd">Read the Python sources in the script directory and create a PDF of all their</span>
<span class="sd">source codes.</span>

<span class="sd">The following features are included as a specialty:</span>
<span class="sd">1. HTML source for pymupdf.Story created via Python API exclusively</span>
<span class="sd">2. Separate Story objects for page headers and footers</span>
<span class="sd">3. Use of HTML &quot;id&quot; elements for identifying source start pages</span>
<span class="sd">4. Generate a Table of Contents pointing to source file starts. This</span>
<span class="sd">   - uses the new Stoy callback feature</span>
<span class="sd">   - uses Story also for making the TOC page(s)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">THISDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">TOC</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># this will contain the TOC list items</span>
<span class="n">CURRENT_ID</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># currently processed filename - stored by recorder func</span>
<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;a4-l&quot;</span><span class="p">)</span>  <span class="c1"># chosen page size</span>
<span class="n">WHERE</span> <span class="o">=</span> <span class="n">MEDIABOX</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>  <span class="c1"># sub rectangle for source content</span>
<span class="c1"># location of the header rectangle</span>
<span class="n">HDR_WHERE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">MEDIABOX</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="c1"># location of the footer rectangle</span>
<span class="n">FTR_WHERE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="n">MEDIABOX</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">36</span><span class="p">,</span> <span class="n">MEDIABOX</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">36</span><span class="p">,</span> <span class="n">MEDIABOX</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">recorder</span><span class="p">(</span><span class="n">elpos</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Callback function invoked during story.place().</span>
<span class="sd">    This function generates / collects all TOC items and updates the value of</span>
<span class="sd">    CURRENT_ID - which is used to update the footer line of each page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">TOC</span><span class="p">,</span> <span class="n">CURRENT_ID</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">elpos</span><span class="o">.</span><span class="n">open_close</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only consider &quot;open&quot; items</span>
        <span class="k">return</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">elpos</span><span class="o">.</span><span class="n">heading</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">elpos</span><span class="o">.</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># top of written rectangle (use for TOC)</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this is a header (h1 - h6)</span>
        <span class="n">pno</span> <span class="o">=</span> <span class="n">elpos</span><span class="o">.</span><span class="n">page</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># the page number</span>
        <span class="n">TOC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">level</span><span class="p">,</span>
                <span class="n">elpos</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                <span class="n">elpos</span><span class="o">.</span><span class="n">page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">y0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">CURRENT_ID</span> <span class="o">=</span> <span class="n">elpos</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">elpos</span><span class="o">.</span><span class="n">id</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># update for footer line</span>
    <span class="k">return</span>


<span class="k">def</span><span class="w"> </span><span class="nf">header_story</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make the page header&quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>
    <span class="n">hdr_body</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">body</span>
    <span class="n">hdr_body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span>
        <span class="n">align</span><span class="o">=</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">TEXT_ALIGN_CENTER</span><span class="p">,</span>
        <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;#eee&quot;</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span>
        <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">header</span>


<span class="k">def</span><span class="w"> </span><span class="nf">footer_story</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make the page footer&quot;&quot;&quot;</span>
    <span class="n">footer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>
    <span class="n">ftr_body</span> <span class="o">=</span> <span class="n">footer</span><span class="o">.</span><span class="n">body</span>
    <span class="n">ftr_body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span>
        <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;#eee&quot;</span><span class="p">,</span>
        <span class="n">align</span><span class="o">=</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">TEXT_ALIGN_CENTER</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">footer</span>


<span class="k">def</span><span class="w"> </span><span class="nf">code_printer</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Output the generated PDF to outfile.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">MAX_TITLE_LEN</span>
    <span class="n">where</span> <span class="o">=</span> <span class="o">+</span><span class="n">WHERE</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">print_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S (%z)&quot;</span><span class="p">)</span>
    <span class="n">thispath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">thispath</span><span class="p">)</span>

    <span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>
    <span class="n">body</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Python sources in folder &#39;</span><span class="si">{</span><span class="n">THISDIR</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

    <span class="n">body</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># the only h1 item in the story</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">THISDIR</span><span class="p">)</span>  <span class="c1"># list / select Python files in our directory</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">code_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">code_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># read Python file source</span>
        <span class="n">fileinput</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">THISDIR</span><span class="p">,</span> <span class="n">code_file</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">fileinput</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># make level 2 header</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">set_pagebreak_before</span><span class="p">()</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Listing of file &#39;</span><span class="si">{</span><span class="n">code_file</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Write the file code</span>
        <span class="n">body</span><span class="o">.</span><span class="n">add_codeblock</span><span class="p">()</span><span class="o">.</span><span class="n">set_bgcolor</span><span class="p">((</span><span class="mi">240</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">210</span><span class="p">))</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span>
            <span class="n">code_file</span>
        <span class="p">)</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># Indicate end of a source file</span>
        <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span><span class="o">.</span><span class="n">set_align</span><span class="p">(</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">TEXT_ALIGN_CENTER</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;---------- End of File &#39;</span><span class="si">{</span><span class="n">code_file</span><span class="si">}</span><span class="s2">&#39; ----------&quot;</span>
        <span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># update file counter</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>
        <span class="c1"># create Story objects for header, footer and the rest.</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header_story</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Python Files in &#39;</span><span class="si">{</span><span class="n">THISDIR</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">hdr_ok</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">HDR_WHERE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hdr_ok</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;header does not fit&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># --------------------------------------------------------------</span>
        <span class="c1"># Write the file content.</span>
        <span class="c1"># --------------------------------------------------------------</span>
        <span class="n">more</span><span class="p">,</span> <span class="n">filled</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>
        <span class="c1"># Inform the callback function</span>
        <span class="c1"># Args:</span>
        <span class="c1">#   recorder: the Python function to call</span>
        <span class="c1">#   {}: dictionary containing anything - we pass the page number</span>
        <span class="n">story</span><span class="o">.</span><span class="n">element_positions</span><span class="p">(</span><span class="n">recorder</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># --------------------------------------------------------------</span>
        <span class="c1"># Make / write page footer.</span>
        <span class="c1"># We MUST have a paragraph b/o background color / alignment</span>
        <span class="c1"># --------------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">CURRENT_ID</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">CURRENT_ID</span><span class="si">}</span><span class="s2">&#39; printed at </span><span class="si">{</span><span class="n">print_time</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="mi">160</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="si">}{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="mi">160</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="si">}</span><span class="s2">Page </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Printed at </span><span class="si">{</span><span class="n">print_time</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="mi">160</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="si">}{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="mi">160</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="si">}</span><span class="s2">Page </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">footer</span> <span class="o">=</span> <span class="n">footer_story</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="c1"># write the page footer</span>
        <span class="n">ftr_ok</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">footer</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">FTR_WHERE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ftr_ok</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;footer does not fit&quot;</span><span class="p">)</span>
        <span class="n">footer</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">more</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PYTEST_CURRENT_TEST&#39;</span><span class="p">):</span>
    <span class="n">fileptr1</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">code_printer</span><span class="p">(</span><span class="n">fileptr1</span><span class="p">)</span>  <span class="c1"># make the PDF</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">fileptr1</span><span class="p">)</span>
    <span class="n">old_count</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">page_count</span>
    <span class="c1"># -----------------------------------------------------------------------------</span>
    <span class="c1"># Post-processing step to make / insert the toc</span>
    <span class="c1"># This also works using pymupdf.Story:</span>
    <span class="c1"># - make a new PDF in memory which contains pages with the TOC text</span>
    <span class="c1"># - add these TOC pages to the end of the original file</span>
    <span class="c1"># - search item text on the inserted pages and cover each with a PDF link</span>
    <span class="c1"># - move the TOC pages to the front of the document</span>
    <span class="c1"># -----------------------------------------------------------------------------</span>
    <span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>
    <span class="n">body</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s2">&quot;Table of Contents&quot;</span><span class="p">)</span>
    <span class="c1"># prefix TOC with an entry pointing to this page</span>
    <span class="n">TOC</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Table of Contents&quot;</span><span class="p">,</span> <span class="n">old_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">36</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">TOC</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># write the file name headers as TOC lines</span>
        <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span>
            <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; - (</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="n">fileptr2</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>  <span class="c1"># put TOC pages to a separate PDF initially</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="n">fileptr2</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">more</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header_story</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Python Files in &#39;</span><span class="si">{</span><span class="n">THISDIR</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="c1"># write the page header</span>
        <span class="n">hdr_ok</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">HDR_WHERE</span><span class="p">)</span>
        <span class="n">header</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">more</span><span class="p">,</span> <span class="n">filled</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
        <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">footer</span> <span class="o">=</span> <span class="n">footer_story</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TOC-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># separate page numbering scheme</span>
        <span class="c1"># write the page footer</span>
        <span class="n">ftr_ok</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">footer</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">FTR_WHERE</span><span class="p">)</span>
        <span class="n">footer</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">doc2</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">fileptr2</span><span class="p">)</span>  <span class="c1"># open TOC pages as another PDF</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">insert_pdf</span><span class="p">(</span><span class="n">doc2</span><span class="p">)</span>  <span class="c1"># and append to the main PDF</span>
    <span class="n">new_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">old_count</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">page_count</span><span class="p">)</span>  <span class="c1"># the TOC page numbers</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new_range</span><span class="p">]</span>  <span class="c1"># these are the TOC pages within main PDF</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">TOC</span><span class="p">:</span>  <span class="c1"># search for TOC item text to get its rectangle</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
            <span class="n">rl</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">flags</span><span class="o">=</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">TEXTFLAGS_SEARCH</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rl</span> <span class="o">!=</span> <span class="p">[]:</span>  <span class="c1"># this text must be on next page</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Cannot find </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">=}</span><span class="s1"> in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span><span class="si">=}</span><span class="s1">.&#39;</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">rl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># rectangle of TOC item text</span>
        <span class="n">link</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># make a link from it</span>
            <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">LINK_GOTO</span><span class="p">,</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">rect</span><span class="p">,</span>
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
            <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">page</span><span class="o">.</span><span class="n">insert_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

    <span class="c1"># insert the TOC in the main PDF</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">set_toc</span><span class="p">(</span><span class="n">TOC</span><span class="p">)</span>
    <span class="c1"># move all the TOC pages to the desired place (1st page here)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new_range</span><span class="p">:</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">move_page</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">page_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">ez_save</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p></details></p>
<p>它具有以下功能：</p>
<ul>
<li><p>使用专门的 <a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a> 在文档开头的单独编号页面上自动生成目录 (TOC)。</p></li>
<li><p>每页使用 3 个单独的 <a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a> 对象：页眉故事、页脚故事和用于打印 Python 源的故事。</p>
<blockquote>
<div><ul class="simple">
<li><p>页面 <strong>页脚会自动更改</strong> 以显示当前 Python 文件的名称。</p></li>
</ul>
</div></blockquote>
</li>
<li><p>使用 <a class="reference internal" href="story-class.html#Story.element_positions" title="Story.element_positions"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.element_positions()</span></code></a> 收集目录数据并动态调整页脚。这是故事输出过程和脚本之间 <strong>双向通信</strong> 的示例。</p></li>
<li><p>带有 Python 源的主 PDF 正在由其 <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> 写入内存。然后使用另一个 <a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a> / <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> 对为目录页面创建（内存）PDF。最后，将这两个 PDF 合并并将结果存储到磁盘。</p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">英文</label><div class="tab-content docutils container">
<p>This script lists the source code of all Python scripts that live in the script’s directory.</p>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/code-printer.py</span></code></p></li>
</ul>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demo script PyMuPDF Story class</span>
<span class="sd">-------------------------------</span>

<span class="sd">Read the Python sources in the script directory and create a PDF of all their</span>
<span class="sd">source codes.</span>

<span class="sd">The following features are included as a specialty:</span>
<span class="sd">1. HTML source for pymupdf.Story created via Python API exclusively</span>
<span class="sd">2. Separate Story objects for page headers and footers</span>
<span class="sd">3. Use of HTML &quot;id&quot; elements for identifying source start pages</span>
<span class="sd">4. Generate a Table of Contents pointing to source file starts. This</span>
<span class="sd">   - uses the new Stoy callback feature</span>
<span class="sd">   - uses Story also for making the TOC page(s)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>

<span class="n">THISDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">TOC</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># this will contain the TOC list items</span>
<span class="n">CURRENT_ID</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># currently processed filename - stored by recorder func</span>
<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;a4-l&quot;</span><span class="p">)</span>  <span class="c1"># chosen page size</span>
<span class="n">WHERE</span> <span class="o">=</span> <span class="n">MEDIABOX</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>  <span class="c1"># sub rectangle for source content</span>
<span class="c1"># location of the header rectangle</span>
<span class="n">HDR_WHERE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">MEDIABOX</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="c1"># location of the footer rectangle</span>
<span class="n">FTR_WHERE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="n">MEDIABOX</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">36</span><span class="p">,</span> <span class="n">MEDIABOX</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">36</span><span class="p">,</span> <span class="n">MEDIABOX</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">recorder</span><span class="p">(</span><span class="n">elpos</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Callback function invoked during story.place().</span>
<span class="sd">    This function generates / collects all TOC items and updates the value of</span>
<span class="sd">    CURRENT_ID - which is used to update the footer line of each page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">TOC</span><span class="p">,</span> <span class="n">CURRENT_ID</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">elpos</span><span class="o">.</span><span class="n">open_close</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only consider &quot;open&quot; items</span>
        <span class="k">return</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">elpos</span><span class="o">.</span><span class="n">heading</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">elpos</span><span class="o">.</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># top of written rectangle (use for TOC)</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this is a header (h1 - h6)</span>
        <span class="n">pno</span> <span class="o">=</span> <span class="n">elpos</span><span class="o">.</span><span class="n">page</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># the page number</span>
        <span class="n">TOC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">level</span><span class="p">,</span>
                <span class="n">elpos</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                <span class="n">elpos</span><span class="o">.</span><span class="n">page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">y0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">CURRENT_ID</span> <span class="o">=</span> <span class="n">elpos</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">elpos</span><span class="o">.</span><span class="n">id</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># update for footer line</span>
    <span class="k">return</span>


<span class="k">def</span><span class="w"> </span><span class="nf">header_story</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make the page header&quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>
    <span class="n">hdr_body</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">body</span>
    <span class="n">hdr_body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span>
        <span class="n">align</span><span class="o">=</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">TEXT_ALIGN_CENTER</span><span class="p">,</span>
        <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;#eee&quot;</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span>
        <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">header</span>


<span class="k">def</span><span class="w"> </span><span class="nf">footer_story</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make the page footer&quot;&quot;&quot;</span>
    <span class="n">footer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>
    <span class="n">ftr_body</span> <span class="o">=</span> <span class="n">footer</span><span class="o">.</span><span class="n">body</span>
    <span class="n">ftr_body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span>
        <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;#eee&quot;</span><span class="p">,</span>
        <span class="n">align</span><span class="o">=</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">TEXT_ALIGN_CENTER</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">footer</span>


<span class="k">def</span><span class="w"> </span><span class="nf">code_printer</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Output the generated PDF to outfile.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">MAX_TITLE_LEN</span>
    <span class="n">where</span> <span class="o">=</span> <span class="o">+</span><span class="n">WHERE</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">print_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S (%z)&quot;</span><span class="p">)</span>
    <span class="n">thispath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">thispath</span><span class="p">)</span>

    <span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>
    <span class="n">body</span><span class="o">.</span><span class="n">set_properties</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Python sources in folder &#39;</span><span class="si">{</span><span class="n">THISDIR</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

    <span class="n">body</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># the only h1 item in the story</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">THISDIR</span><span class="p">)</span>  <span class="c1"># list / select Python files in our directory</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">code_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">code_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># read Python file source</span>
        <span class="n">fileinput</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">THISDIR</span><span class="p">,</span> <span class="n">code_file</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">fileinput</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># make level 2 header</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">set_pagebreak_before</span><span class="p">()</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Listing of file &#39;</span><span class="si">{</span><span class="n">code_file</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Write the file code</span>
        <span class="n">body</span><span class="o">.</span><span class="n">add_codeblock</span><span class="p">()</span><span class="o">.</span><span class="n">set_bgcolor</span><span class="p">((</span><span class="mi">240</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">210</span><span class="p">))</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span>
            <span class="n">code_file</span>
        <span class="p">)</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># Indicate end of a source file</span>
        <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span><span class="o">.</span><span class="n">set_align</span><span class="p">(</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">TEXT_ALIGN_CENTER</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;---------- End of File &#39;</span><span class="si">{</span><span class="n">code_file</span><span class="si">}</span><span class="s2">&#39; ----------&quot;</span>
        <span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># update file counter</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>
        <span class="c1"># create Story objects for header, footer and the rest.</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header_story</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Python Files in &#39;</span><span class="si">{</span><span class="n">THISDIR</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">hdr_ok</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">HDR_WHERE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hdr_ok</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;header does not fit&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># --------------------------------------------------------------</span>
        <span class="c1"># Write the file content.</span>
        <span class="c1"># --------------------------------------------------------------</span>
        <span class="n">more</span><span class="p">,</span> <span class="n">filled</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">where</span><span class="p">)</span>
        <span class="c1"># Inform the callback function</span>
        <span class="c1"># Args:</span>
        <span class="c1">#   recorder: the Python function to call</span>
        <span class="c1">#   {}: dictionary containing anything - we pass the page number</span>
        <span class="n">story</span><span class="o">.</span><span class="n">element_positions</span><span class="p">(</span><span class="n">recorder</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># --------------------------------------------------------------</span>
        <span class="c1"># Make / write page footer.</span>
        <span class="c1"># We MUST have a paragraph b/o background color / alignment</span>
        <span class="c1"># --------------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">CURRENT_ID</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">CURRENT_ID</span><span class="si">}</span><span class="s2">&#39; printed at </span><span class="si">{</span><span class="n">print_time</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="mi">160</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="si">}{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="mi">160</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="si">}</span><span class="s2">Page </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Printed at </span><span class="si">{</span><span class="n">print_time</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="mi">160</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="si">}{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="mi">160</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="si">}</span><span class="s2">Page </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">footer</span> <span class="o">=</span> <span class="n">footer_story</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="c1"># write the page footer</span>
        <span class="n">ftr_ok</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">footer</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">FTR_WHERE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ftr_ok</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;footer does not fit&quot;</span><span class="p">)</span>
        <span class="n">footer</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">more</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PYTEST_CURRENT_TEST&#39;</span><span class="p">):</span>
    <span class="n">fileptr1</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">code_printer</span><span class="p">(</span><span class="n">fileptr1</span><span class="p">)</span>  <span class="c1"># make the PDF</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">fileptr1</span><span class="p">)</span>
    <span class="n">old_count</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">page_count</span>
    <span class="c1"># -----------------------------------------------------------------------------</span>
    <span class="c1"># Post-processing step to make / insert the toc</span>
    <span class="c1"># This also works using pymupdf.Story:</span>
    <span class="c1"># - make a new PDF in memory which contains pages with the TOC text</span>
    <span class="c1"># - add these TOC pages to the end of the original file</span>
    <span class="c1"># - search item text on the inserted pages and cover each with a PDF link</span>
    <span class="c1"># - move the TOC pages to the front of the document</span>
    <span class="c1"># -----------------------------------------------------------------------------</span>
    <span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>
    <span class="n">body</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s2">&quot;Table of Contents&quot;</span><span class="p">)</span>
    <span class="c1"># prefix TOC with an entry pointing to this page</span>
    <span class="n">TOC</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Table of Contents&quot;</span><span class="p">,</span> <span class="n">old_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">36</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">TOC</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># write the file name headers as TOC lines</span>
        <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span>
            <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; - (</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="n">fileptr2</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>  <span class="c1"># put TOC pages to a separate PDF initially</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="n">fileptr2</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">more</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header_story</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Python Files in &#39;</span><span class="si">{</span><span class="n">THISDIR</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="c1"># write the page header</span>
        <span class="n">hdr_ok</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">HDR_WHERE</span><span class="p">)</span>
        <span class="n">header</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">more</span><span class="p">,</span> <span class="n">filled</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
        <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">footer</span> <span class="o">=</span> <span class="n">footer_story</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TOC-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># separate page numbering scheme</span>
        <span class="c1"># write the page footer</span>
        <span class="n">ftr_ok</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">footer</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">FTR_WHERE</span><span class="p">)</span>
        <span class="n">footer</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">doc2</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">fileptr2</span><span class="p">)</span>  <span class="c1"># open TOC pages as another PDF</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">insert_pdf</span><span class="p">(</span><span class="n">doc2</span><span class="p">)</span>  <span class="c1"># and append to the main PDF</span>
    <span class="n">new_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">old_count</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">page_count</span><span class="p">)</span>  <span class="c1"># the TOC page numbers</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new_range</span><span class="p">]</span>  <span class="c1"># these are the TOC pages within main PDF</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">TOC</span><span class="p">:</span>  <span class="c1"># search for TOC item text to get its rectangle</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
            <span class="n">rl</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">flags</span><span class="o">=</span><span class="n">pymupdf</span><span class="o">.</span><span class="n">TEXTFLAGS_SEARCH</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rl</span> <span class="o">!=</span> <span class="p">[]:</span>  <span class="c1"># this text must be on next page</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Cannot find </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">=}</span><span class="s1"> in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span><span class="si">=}</span><span class="s1">.&#39;</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">rl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># rectangle of TOC item text</span>
        <span class="n">link</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># make a link from it</span>
            <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">LINK_GOTO</span><span class="p">,</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">rect</span><span class="p">,</span>
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
            <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">page</span><span class="o">.</span><span class="n">insert_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

    <span class="c1"># insert the TOC in the main PDF</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">set_toc</span><span class="p">(</span><span class="n">TOC</span><span class="p">)</span>
    <span class="c1"># move all the TOC pages to the desired place (1st page here)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new_range</span><span class="p">:</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">move_page</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">page_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">ez_save</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p></details></p>
<p>It features the following capabilities:</p>
<ul>
<li><p>Automatic generation of a Table of Contents (TOC) on separately numbered pages at the start of the document - using a specialized <a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a>.</p></li>
<li><p>Use of 3 separate <a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a> objects per page: header story, footer story and the story for printing the Python sources.</p>
<blockquote>
<div><ul class="simple">
<li><p>The page <strong>footer is automatically changed</strong> to show the name of the current Python file.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Use of <a class="reference internal" href="story-class.html#Story.element_positions" title="Story.element_positions"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.element_positions()</span></code></a> to collect the data for the TOC and for the dynamic adjustment of page footers. This is an example of a <strong>bidirectional communication</strong> between the story output process and the script.</p></li>
<li><p>The main PDF with the Python sources is being written to memory by its <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a>. Another <a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a> / <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> pair is then used to create a (memory) PDF for the TOC pages. Finally, both these PDFs are joined and the result stored to disk.</p></li>
</ul>
</div>
</div>
<hr class="docutils" />
</section>
<section id="json">
<span id="recipesstories-k"></span><h2>如何显示 JSON 数据列表<a class="headerlink" href="#json" title="此标题的永久链接">#</a></h2>
<p>How to Display a List from JSON Data</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">中文</label><div class="tab-content docutils container">
<p>此示例采用一些 JSON 数据输入，用于填充 <a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a>。它还包含一些可视文本格式，并展示了如何添加链接。</p>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/json-example.py</span></code></p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">英文</label><div class="tab-content docutils container">
<p>This example takes some JSON data input which it uses to populate a <a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a>. It also contains some visual text formatting and shows how to add links.</p>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/json-example.py</span></code></p></li>
</ul>
</div>
</div>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="n">my_json</span> <span class="o">=</span>  <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[</span>
<span class="s2">    {</span>
<span class="s2">         &quot;name&quot; :           &quot;Five-storied Pagoda&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Rurikō-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;middle Muromachi period, 1442&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Yamaguchi, Yamaguchi&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.190181,131.472917&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Founder&#39;s Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Eihō-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;early Muromachi period&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Tajimi, Gifu&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;35.346144,137.129189&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Fudōdō&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Kongōbu-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;early Kamakura period&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Kōya, Wakayama&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.213103,135.580397&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Goeidō&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Nishi Honganji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;Edo period, 1636&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Kyoto&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.991394,135.751689&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Golden Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Murō-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;early Heian period&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Uda, Nara&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.536586819357986,136.0395548452301&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Golden Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Fudō-in&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;late Muromachi period, 1540&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Hiroshima&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.427014,132.471117&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Golden Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Ninna-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;Momoyama period, 1613&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Kyoto&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;35.031078,135.713811&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Golden Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Mii-dera&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;Momoyama period, 1599&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Ōtsu, Shiga&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;35.013403,135.852861&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Golden Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Tōshōdai-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;Nara period, 8th century&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Nara, Nara&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.675619,135.784842&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Golden Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Tō-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;Momoyama period, 1603&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Kyoto&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.980367,135.747686&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Golden Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Tōdai-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;middle Edo period, 1705&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Nara, Nara&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.688992,135.839822&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Golden Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Hōryū-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;Asuka period, by 693&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Ikaruga, Nara&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.614317,135.734458&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Golden Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Daigo-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;late Heian period&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Kyoto&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.951481,135.821747&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Keigū-in Main Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Kōryū-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;early Kamakura period, before 1251&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Kyoto&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;35.015028,135.705425&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Konpon-chūdō&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Enryaku-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;early Edo period, 1640&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Ōtsu, Shiga&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;35.070456,135.840942&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Korō&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Tōshōdai-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;early Kamakura period, 1240&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Nara, Nara&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.675847,135.785069&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Kōfūzō&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Hōryū-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;early Heian period&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Ikaruga, Nara&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.614439,135.735428&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Large Lecture Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Hōryū-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;middle Heian period, 990&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Ikaruga, Nara&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.614783,135.734175&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Lecture Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Zuiryū-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;early Edo period, 1655&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Takaoka, Toyama&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;36.735689,137.010019&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Lecture Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Tōshōdai-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;Nara period, 763&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Nara, Nara&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.675933,135.784842&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Lotus Flower Gate&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Tō-ji&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;early Kamakura period&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Kyoto&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.980678,135.746314&quot;</span>
<span class="s2">     },</span>
<span class="s2">     {</span>
<span class="s2">         &quot;name&quot; :           &quot;Main Hall&quot;,</span>
<span class="s2">         &quot;temple&quot; :         &quot;Akishinodera&quot;,</span>
<span class="s2">         &quot;founded&quot; :        &quot;early Kamakura period&quot;,</span>
<span class="s2">         &quot;region&quot; :         &quot;Nara, Nara&quot;,</span>
<span class="s2">         &quot;position&quot; :       &quot;34.703769,135.776189&quot;</span>
<span class="s2">     }</span>
<span class="s2">]</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># the result is a Python dictionary:</span>
<span class="n">my_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">my_json</span><span class="p">)</span>

<span class="n">MEDIABOX</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">paper_rect</span><span class="p">(</span><span class="s2">&quot;letter&quot;</span><span class="p">)</span>  <span class="c1"># output page format: Letter</span>
<span class="n">WHERE</span> <span class="o">=</span> <span class="n">MEDIABOX</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="s2">&quot;json-example.pdf&quot;</span><span class="p">)</span>  <span class="c1"># create the writer</span>

<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">()</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">body</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">my_dict</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span><span class="p">:</span>
            <span class="n">para</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">para</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;www.google.com/maps/@</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">,14z&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">para</span><span class="o">.</span><span class="n">add_span</span><span class="p">()</span>
            <span class="n">para</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;#990000&quot;</span><span class="p">)</span>
            <span class="n">para</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">para</span><span class="o">.</span><span class="n">set_bold</span><span class="p">()</span>
            <span class="n">para</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="n">para</span><span class="o">.</span><span class="n">add_span</span><span class="p">()</span>
            <span class="n">para</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
            <span class="n">para</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">body</span><span class="o">.</span><span class="n">add_horizontal_line</span><span class="p">()</span>

<span class="c1"># This while condition will check a value from the Story `place` method</span>
<span class="c1"># for whether all content for the story has been written (0), otherwise</span>
<span class="c1"># more content is waiting to be written (1)</span>
<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">while</span> <span class="n">more</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">begin_page</span><span class="p">(</span><span class="n">MEDIABOX</span><span class="p">)</span>  <span class="c1"># make new page</span>
    <span class="n">more</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">story</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
    <span class="n">story</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">end_page</span><span class="p">()</span>  <span class="c1"># finish page</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close output file</span>

<span class="k">del</span> <span class="n">story</span>
</pre></div>
</div>
<p></details></p>
<hr class="docutils" />
</section>
<section id="story-write">
<span id="recipesstories-l"></span><h2>使用替代的 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write*()</span></code> 函数<a class="headerlink" href="#story-write" title="此标题的永久链接">#</a></h2>
<p>Using the Alternative <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write*()</span></code> functions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">中文</label><div class="tab-content docutils container">
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write*()</span></code> 函数提供了一种使用
<a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a> 功能的另一种方式，无需调用代码来实现
一个调用 <a class="reference internal" href="story-class.html#Story.place" title="Story.place"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.place()</span></code></a> 和 <a class="reference internal" href="story-class.html#Story.draw" title="Story.draw"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.draw()</span></code></a> 等的循环，但
必须至少提供一个 <code class="xref any docutils literal notranslate"><span class="pre">rectfn()</span></code> 回调。</p>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">英文</label><div class="tab-content docutils container">
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write*()</span></code> functions provide a different way to use the
<a class="reference internal" href="story-class.html#story"><span class="std std-ref">Story</span></a> functionality, removing the need for calling code to implement
a loop that calls <a class="reference internal" href="story-class.html#Story.place" title="Story.place"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.place()</span></code></a> and <a class="reference internal" href="story-class.html#Story.draw" title="Story.draw"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.draw()</span></code></a> etc, at the
expense of having to provide at least a <code class="xref any docutils literal notranslate"><span class="pre">rectfn()</span></code> callback.</p>
</div>
</div>
<section id="recipesstories-l-a">
<span id="id12"></span><h3>如何使用 <a class="reference internal" href="story-class.html#Story.write" title="Story.write"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write()</span></code></a> 进行基本布局<a class="headerlink" href="#recipesstories-l-a" title="此标题的永久链接">#</a></h3>
<p>How to do Basic Layout with <a class="reference internal" href="story-class.html#Story.write" title="Story.write"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write()</span></code></a></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--13-input--1" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--1">中文</label><div class="tab-content docutils container">
<p>此脚本将其自身源代码的多个副本布局为每页四个矩形。</p>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/story-write.py</span></code></p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--13-input--2" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--2">英文</label><div class="tab-content docutils container">
<p>This script lays out multiple copies of its own source code, into four
rectangles per page.</p>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/story-write.py</span></code></p></li>
</ul>
</div>
</div>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demo script for PyMuPDF&#39;s `Story.write()` method.</span>

<span class="sd">This is a way of laying out a story into a PDF document, that avoids the need</span>
<span class="sd">to write a loop that calls `story.place()` and `story.draw()`.</span>

<span class="sd">Instead just a single function call is required, albeit with a `rectfn()`</span>
<span class="sd">callback that returns the rectangles into which the story is placed.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">html</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>


<span class="c1"># Create html containing multiple copies of our own source code.</span>
<span class="c1">#</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">html</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;!DOCTYPE html&gt;</span>
<span class="s1">&lt;body&gt;</span>

<span class="s1">&lt;h1&gt;Contents of </span><span class="si">{</span><span class="vm">__file__</span><span class="si">}</span><span class="s1">&lt;/h1&gt;</span>

<span class="s1">&lt;h2&gt;Normal&lt;/h2&gt;</span>
<span class="s1">&lt;pre&gt;</span>
<span class="si">{</span><span class="n">text</span><span class="si">}</span>
<span class="s1">&lt;/pre&gt;</span>

<span class="s1">&lt;h2&gt;Strong&lt;/h2&gt;</span>
<span class="s1">&lt;strong&gt;</span>
<span class="s1">&lt;pre&gt;</span>
<span class="si">{</span><span class="n">text</span><span class="si">}</span>
<span class="s1">&lt;/pre&gt;</span>
<span class="s1">&lt;/strong&gt;</span>

<span class="s1">&lt;h2&gt;Em&lt;/h2&gt;</span>
<span class="s1">&lt;em&gt;</span>
<span class="s1">&lt;pre&gt;</span>
<span class="si">{</span><span class="n">text</span><span class="si">}</span>
<span class="s1">&lt;/pre&gt;</span>
<span class="s1">&lt;/em&gt;</span>

<span class="s1">&lt;/body&gt;</span>
<span class="s1">&#39;&#39;&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rectfn</span><span class="p">(</span><span class="n">rect_num</span><span class="p">,</span> <span class="n">filled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    We return four rectangles per page in this order:</span>
<span class="sd">    </span>
<span class="sd">        1 3</span>
<span class="sd">        2 4</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">page_w</span> <span class="o">=</span> <span class="mi">800</span>
    <span class="n">page_h</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">rect_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_w</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">rect_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_h</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="k">if</span> <span class="n">rect_num</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># New page.</span>
        <span class="n">mediabox</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page_w</span><span class="p">,</span> <span class="n">page_h</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mediabox</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Return one of four rects in turn.</span>
    <span class="n">rect_x</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="p">(</span><span class="n">rect_w</span><span class="o">+</span><span class="n">margin</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">rect_num</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">rect_y</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="p">(</span><span class="n">rect_h</span><span class="o">+</span><span class="n">margin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rect_num</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">rect_x</span><span class="p">,</span> <span class="n">rect_y</span><span class="p">,</span> <span class="n">rect_x</span> <span class="o">+</span> <span class="n">rect_w</span><span class="p">,</span> <span class="n">rect_y</span> <span class="o">+</span> <span class="n">rect_h</span><span class="p">)</span>
    <span class="c1">#print(f&#39;rectfn(): rect_num={rect_num} filled={filled}. Returning: rect={rect}&#39;)</span>
    <span class="k">return</span> <span class="n">mediabox</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="kc">None</span>

<span class="n">story</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">em</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="n">out_path</span> <span class="o">=</span> <span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>

<span class="n">story</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">rectfn</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p></details></p>
<hr class="docutils" />
</section>
<section id="story-write-stabilized">
<span id="recipesstories-l-b"></span><h3>如何使用 <a class="reference internal" href="story-class.html#Story.write_stabilized" title="Story.write_stabilized"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized()</span></code></a> 对目录进行迭代布局<a class="headerlink" href="#story-write-stabilized" title="此标题的永久链接">#</a></h3>
<p>How to do Iterative Layout for a Table of Contents with <a class="reference internal" href="story-class.html#Story.write_stabilized" title="Story.write_stabilized"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized()</span></code></a></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--14-input--1" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--1">中文</label><div class="tab-content docutils container">
<p>此脚本动态创建 html 内容，并根据具有非零 <code class="xref any docutils literal notranslate"><span class="pre">.heading</span></code> 值的 <span class="xref std std-ref">ElementPosition</span> 项添加内容部分。</p>
<p>内容部分位于文档的开头，因此对内容的修改可能会更改文档其余部分的页码，进而导致内容部分的页码不正确。</p>
<p>因此，脚本使用 <a class="reference internal" href="story-class.html#Story.write_stabilized" title="Story.write_stabilized"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized()</span></code></a> 反复布局，直到一切稳定。</p>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/story-write-stabilized.py</span></code></p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--14-input--2" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--2">英文</label><div class="tab-content docutils container">
<p>This script creates html content dynamically, adding a contents section based
on <span class="xref std std-ref">ElementPosition</span> items that have non-zero <code class="xref any docutils literal notranslate"><span class="pre">.heading</span></code> values.</p>
<p>The contents section is at the start of the document, so modifications to the
contents can change page numbers in the rest of the document, which in turn can
cause page numbers in the contents section to be incorrect.</p>
<p>So the script uses <a class="reference internal" href="story-class.html#Story.write_stabilized" title="Story.write_stabilized"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized()</span></code></a> to repeatedly lay things
out until things are stable.</p>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/story-write-stabilized.py</span></code></p></li>
</ul>
</div>
</div>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demo script for PyMuPDF&#39;s `pymupdf.Story.write_stabilized()`.</span>

<span class="sd">`pymupdf.Story.write_stabilized()` is similar to `pymupdf.Story.write()`,</span>
<span class="sd">except instead of taking a fixed html document, it does iterative layout</span>
<span class="sd">of dynamically-generated html content (provided by a callback) to a</span>
<span class="sd">`pymupdf.DocumentWriter`.</span>

<span class="sd">For example this allows one to add a dynamically-generated table of contents</span>
<span class="sd">section while ensuring that page numbers are patched up until stable.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rectfn</span><span class="p">(</span><span class="n">rect_num</span><span class="p">,</span> <span class="n">filled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    We return one rect per page.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">380</span><span class="p">)</span>
    <span class="n">mediabox</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    <span class="c1">#print(f&#39;rectfn(): rect_num={rect_num} filled={filled}&#39;)</span>
    <span class="k">return</span> <span class="n">mediabox</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">contentfn</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns html content, with a table of contents derived from `positions`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            &lt;!DOCTYPE html&gt;</span>
<span class="s1">            &lt;body&gt;</span>
<span class="s1">            &lt;h2&gt;Contents&lt;/h2&gt;</span>
<span class="s1">            &lt;ul&gt;</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create table of contents with links to all &lt;h1..6&gt; sections in the</span>
    <span class="c1"># document.</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">heading</span> <span class="ow">and</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">open_close</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">text</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    &lt;li&gt;&lt;a href=</span><span class="se">\&quot;</span><span class="s2">#</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&lt;/a&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    &lt;li&gt;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;ul&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;page=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">page_num</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;depth=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">depth</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;heading=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">heading</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;id=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">id</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;href=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">href</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;rect=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">rect</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;text=</span><span class="si">{</span><span class="n">text</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;open_close=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">open_close</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;/ul&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    
    <span class="n">ret</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/ul&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    
    <span class="c1"># Main content.</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    </span>
<span class="s1">            &lt;h1&gt;First section&lt;/h1&gt;</span>
<span class="s1">            &lt;p&gt;Contents of first section.</span>
<span class="s1">            </span>
<span class="s1">            &lt;h1&gt;Second section&lt;/h1&gt;</span>
<span class="s1">            &lt;p&gt;Contents of second section.</span>
<span class="s1">            &lt;h2&gt;Second section first subsection&lt;/h2&gt;</span>
<span class="s1">            </span>
<span class="s1">            &lt;p&gt;Contents of second section first subsection.</span>
<span class="s1">            </span>
<span class="s1">            &lt;h1&gt;Third section&lt;/h1&gt;</span>
<span class="s1">            &lt;p&gt;Contents of third section.</span>
<span class="s1">            </span>
<span class="s1">            &lt;/body&gt;</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>


<span class="n">out_path</span> <span class="o">=</span> <span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">DocumentWriter</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
<span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="o">.</span><span class="n">write_stabilized</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">contentfn</span><span class="p">,</span> <span class="n">rectfn</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p></details></p>
<hr class="docutils" />
</section>
<section id="story-write-stabilized-links-pdf">
<span id="recipesstories-l-c"></span><h3>如何使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized_links()</span></code> 进行迭代布局和创建 PDF 链接<a class="headerlink" href="#story-write-stabilized-links-pdf" title="此标题的永久链接">#</a></h3>
<p>How to do Iterative Layout and Create PDF Links with <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized_links()</span></code></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--15-input--1" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--1">中文</label><div class="tab-content docutils container">
<p>此脚本与上面 “如何使用 <a class="reference internal" href="story-class.html#Story.write_stabilized" title="Story.write_stabilized"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized()</span></code></a> ” 中描述的脚本类似，不同之处在于生成的 PDF 还包含与原始 html 中的内部链接相对应的链接。</p>
<p>这是通过使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized_links()</span></code> 完成的；这与 <a class="reference internal" href="story-class.html#Story.write_stabilized" title="Story.write_stabilized"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized()</span></code></a> 略有不同：</p>
<ul class="simple">
<li><p>它不接受 <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> <code class="xref any docutils literal notranslate"><span class="pre">writer</span></code> 参数。</p></li>
<li><p>它返回 PDF <a class="reference internal" href="document.html#document"><span class="std std-ref">Document</span></a> 实例。</p></li>
</ul>
<p>[原因有点复杂；例如 <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> 不一定是 PDF 编写器，因此在 PDF 特定的 API 中实际上不起作用。]</p>
<p><strong>文件：</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/story-write-stabilized-links.py</span></code></p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--15-input--2" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--2">英文</label><div class="tab-content docutils container">
<p>This script is similar to the one described in “How to use
<a class="reference internal" href="story-class.html#Story.write_stabilized" title="Story.write_stabilized"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized()</span></code></a>” above, except that the generated PDF also
contains links that correspond to the internal links in the original html.</p>
<p>This is done by using <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized_links()</span></code>; this is slightly
different from <a class="reference internal" href="story-class.html#Story.write_stabilized" title="Story.write_stabilized"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized()</span></code></a>:</p>
<ul class="simple">
<li><p>It does not take a <a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> <code class="xref any docutils literal notranslate"><span class="pre">writer</span></code> arg.</p></li>
<li><p>It returns a PDF <a class="reference internal" href="document.html#document"><span class="std std-ref">Document</span></a> instance.</p></li>
</ul>
<p>[The reasons for this are a little involved; for example a
<a class="reference internal" href="document-writer-class.html#documentwriter"><span class="std std-ref">DocumentWriter</span></a> is not necessarily a PDF writer, so doesn’t really work
in a PDF-specific API.]</p>
<p><strong>Files:</strong></p>
<ul class="simple">
<li><p><code class="xref any docutils literal notranslate"><span class="pre">docs/samples/story-write-stabilized-links.py</span></code></p></li>
</ul>
</div>
</div>
<p><details>
<summary><a>See recipe</a></summary></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demo script for PyMuPDF&#39;s `pymupdf.Story.write_stabilized_with_links()`.</span>

<span class="sd">`pymupdf.Story.write_stabilized_links()` is similar to</span>
<span class="sd">`pymupdf.Story.write_stabilized()` except that it creates a PDF `pymupdf.Document`</span>
<span class="sd">that contains PDF links generated from all internal links in the original html.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rectfn</span><span class="p">(</span><span class="n">rect_num</span><span class="p">,</span> <span class="n">filled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    We return one rect per page.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">380</span><span class="p">)</span>
    <span class="n">mediabox</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    <span class="c1">#print(f&#39;rectfn(): rect_num={rect_num} filled={filled}&#39;)</span>
    <span class="k">return</span> <span class="n">mediabox</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">contentfn</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns html content, with a table of contents derived from `positions`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            &lt;!DOCTYPE html&gt;</span>
<span class="s1">            &lt;body&gt;</span>
<span class="s1">            &lt;h2&gt;Contents&lt;/h2&gt;</span>
<span class="s1">            &lt;ul&gt;</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create table of contents with links to all &lt;h1..6&gt; sections in the</span>
    <span class="c1"># document.</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">heading</span> <span class="ow">and</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">open_close</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">text</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    &lt;li&gt;&lt;a href=</span><span class="se">\&quot;</span><span class="s2">#</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&lt;/a&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    &lt;li&gt;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;ul&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;page=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">page_num</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;depth=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">depth</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;heading=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">heading</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;id=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">id</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;href=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">href</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;rect=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">rect</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;text=</span><span class="si">{</span><span class="n">text</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;li&gt;open_close=</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">open_close</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;        &lt;/ul&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
    
    <span class="n">ret</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/ul&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    
    <span class="c1"># Main content.</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    </span>
<span class="s1">            &lt;h1&gt;First section&lt;/h1&gt;</span>
<span class="s1">            &lt;p&gt;Contents of first section.</span>
<span class="s1">            &lt;ul&gt;</span>
<span class="s1">            &lt;li&gt;External &lt;a href=&quot;https://artifex.com/&quot;&gt;link to https://artifex.com/&lt;/a&gt;.</span>
<span class="s1">            &lt;li&gt;&lt;a href=&quot;#idtest&quot;&gt;Link to IDTEST&lt;/a&gt;.</span>
<span class="s1">            &lt;li&gt;&lt;a href=&quot;#nametest&quot;&gt;Link to NAMETEST&lt;/a&gt;.</span>
<span class="s1">            &lt;/ul&gt;</span>
<span class="s1">            </span>
<span class="s1">            &lt;h1&gt;Second section&lt;/h1&gt;</span>
<span class="s1">            &lt;p&gt;Contents of second section.</span>
<span class="s1">            &lt;h2&gt;Second section first subsection&lt;/h2&gt;</span>
<span class="s1">            </span>
<span class="s1">            &lt;p&gt;Contents of second section first subsection.</span>
<span class="s1">            &lt;p id=&quot;idtest&quot;&gt;IDTEST</span>
<span class="s1">            </span>
<span class="s1">            &lt;h1&gt;Third section&lt;/h1&gt;</span>
<span class="s1">            &lt;p&gt;Contents of third section.</span>
<span class="s1">            &lt;p&gt;&lt;a name=&quot;nametest&quot;&gt;NAMETEST&lt;/a&gt;.</span>
<span class="s1">            </span>
<span class="s1">            &lt;/body&gt;</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>


<span class="n">out_path</span> <span class="o">=</span> <span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
<span class="n">document</span> <span class="o">=</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">Story</span><span class="o">.</span><span class="n">write_stabilized_with_links</span><span class="p">(</span><span class="n">contentfn</span><span class="p">,</span> <span class="n">rectfn</span><span class="p">)</span>
<span class="n">document</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
</pre></div>
</div>
<p></details></p>
<hr class="docutils" />
<p class="rubric">Footnotes</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="f1" role="note">
<span class="label"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id5">1</a>,<a role="doc-backlink" href="#id6">2</a>)</span>
<p>HTML &amp; CSS support</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>At the time of writing the HTML engine for Stories is fairly basic and supports a subset of CSS2 attributes.</p>
</div>
<p>Some important CSS support to consider:</p>
<ul class="simple">
<li><p>The only available layout is relative layout.</p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">background</span></code> is unavailable, use <code class="xref any docutils literal notranslate"><span class="pre">background-color</span></code> instead.</p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">float</span></code> is unavailable.</p></li>
</ul>
</aside>
<aside class="footnote brackets" id="f2" role="note">
<span class="label"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id3">1</a>,<a role="doc-backlink" href="#id4">2</a>)</span>
<p>HTML &amp; CSS support</p>
<p>在编写 Stories 的 HTML 引擎时，它相当基础，并且支持 CSS2 属性的子集。</p>
<p>需要考虑的一些重要 CSS 支持：</p>
<ul class="simple">
<li><p>唯一可用的布局是相对布局。</p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">background</span></code> 不可用，请改用 <code class="xref any docutils literal notranslate"><span class="pre">background-color</span></code>。</p></li>
<li><p><code class="xref any docutils literal notranslate"><span class="pre">float</span></code> 不可用。</p></li>
</ul>
</aside>
</aside>
<div class="feedbackLink"><a id="feedbackLinkBottom" target=_blank>您对此页面有任何反馈吗？</b></a></div><hr class="docutils" />
<script>

   var url_string = window.location.href;
   var a = document.getElementById('feedbackLinkBottom');
   a.setAttribute("href", "https://artifex.com/contributor/feedback.php?utm_source=rtd-pymupdf&utm_medium=rtd&utm_content=footer-link&url="+url_string);

</script>

<p style="color:#999" id="footerDisclaimer">本软件按原样提供，不作任何明示或暗示担保。本软件根据许可分发，除非根据该许可条款明确授权，否则不得复制、修改或分发。请参阅 <a href="https://www.artifex.com?utm_source=rtd-pymupdf&utm_medium=rtd&utm_content=footer-link">artifex.com</a> 上的许可信息，或联系 Artifex Software Inc., 39 Mesa Street, Suite 108A, San Francisco CA 94129, United States 了解更多信息。</p>



<script>

   let docLanguage = document.getElementsByTagName('html')[0].getAttribute('lang');

   function getHeaderAndFooterTranslation(str) {
       if (docLanguage == "ja") {
           if (str == "Do you have any feedback on this page?") {
               return "このページに関するご意見はありますか？";
           } else if (str == "Find <b>#pymupdf</b> on <b>Discord</b>") {
               return "<b>Discord</b>の <b>#pymupdf</b> を見つける";
           } else if (str == "This software is provided AS-IS with no warranty, either express or implied. This software is distributed under license and may not be copied, modified or distributed except as expressly authorized under the terms of that license. Refer to licensing information at <a href='https://www.artifex.com?utm_source=rtd-pymupdf&utm_medium=rtd&utm_content=footer-link'>artifex.com</a> or contact Artifex Software Inc., 39 Mesa Street, Suite 108A, San Francisco CA 94129, United States for further information.") {

               return "このソフトウェアは無保証で提供されており、明示または黙示を問わず、いかなる保証もありません。このソフトウェアはライセンスの下で配布され、ライセンスの条件に明示的に許可されている場合を除き、コピー、変更、または配布してはなりません。ライセンシング情報については、<a href='https://www.artifex.com?utm_source=rtd-pymupdf&utm_medium=rtd&utm_content=footer-link'>artifex.com</a>でライセンス情報を参照するか、アメリカ合衆国カリフォルニア州サンフランシスコのArtifex Software Inc. までお問い合わせください。"

           }
       }

       return str;
   }

   document.getElementById("findOnDiscord").innerHTML = getHeaderAndFooterTranslation("Find <b>#pymupdf</b> on <b>Discord</b>");
   document.getElementById("feedbackLinkTop").innerHTML = getHeaderAndFooterTranslation("Do you have any feedback on this page?");
   document.getElementById("feedbackLinkBottom").innerHTML = getHeaderAndFooterTranslation("Do you have any feedback on this page?");
   document.getElementById("footerDisclaimer").innerHTML = getHeaderAndFooterTranslation("This software is provided AS-IS with no warranty, either express or implied. This software is distributed under license and may not be copied, modified or distributed except as expressly authorized under the terms of that license. Refer to licensing information at <a href='https://www.artifex.com?utm_source=rtd-pymupdf&utm_medium=rtd&utm_content=footer-link'>artifex.com</a> or contact Artifex Software Inc., 39 Mesa Street, Suite 108A, San Francisco CA 94129, United States for further information.");


   // more translation for admonition-title as the in-built translation isn't great, needs: 注釈 -> 注
   if (docLanguage == "ja") {
       const collection = document.getElementsByClassName("admonition-title");
       for (var i=0;i<collection.length;i++) {
           collection[i].innerHTML = "注";
       }
   }


</script><p class="footer-version">This documentation covers all versions up to 1.25.4.</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="recipes-journalling.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">日记</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="recipes-drawing-and-graphics.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">绘图和图形</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2015-2025, Artifex
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on 19. 3月 2025</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">故事</a><ul>
<li><a class="reference internal" href="#recipesstories-a">如何添加一行带格式的文本</a></li>
<li><a class="reference internal" href="#recipesstories-b">如何使用图像</a></li>
<li><a class="reference internal" href="#html-css">如何读取故事的外部 HTML 和 CSS</a></li>
<li><a class="reference internal" href="#recipesstories-d">如何使用故事模板输出数据库内容</a></li>
<li><a class="reference internal" href="#pdf">如何与现有 PDF 集成</a></li>
<li><a class="reference internal" href="#pymupdf-fonts">如何从包 pymupdf-fonts 制作多列布局和访问字体</a></li>
<li><a class="reference internal" href="#recipesstories-g">如何制作环绕预定义“禁区”布局的布局</a></li>
<li><a class="reference internal" href="#html">如何输出 HTML 表格</a></li>
<li><a class="reference internal" href="#recipesstories-i">如何创建简单的网格布局</a></li>
<li><a class="reference internal" href="#recipesstories-j">如何生成目录</a></li>
<li><a class="reference internal" href="#json">如何显示 JSON 数据列表</a></li>
<li><a class="reference internal" href="#story-write">使用替代的 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write*()</span></code> 函数</a><ul>
<li><a class="reference internal" href="#recipesstories-l-a">如何使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write()</span></code> 进行基本布局</a></li>
<li><a class="reference internal" href="#story-write-stabilized">如何使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized()</span></code> 对目录进行迭代布局</a></li>
<li><a class="reference internal" href="#story-write-stabilized-links-pdf">如何使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Story.write_stabilized_links()</span></code> 进行迭代布局和创建 PDF 链接</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/scripts/furo.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/tabs.js"></script>
    <script src="_static/translations.js"></script>
    </body>
</html>